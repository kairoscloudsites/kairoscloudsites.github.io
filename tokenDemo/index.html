<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAR Replication: Login to Token</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f4f4f4; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; width: 100%; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #logs { margin-top: 20px; background: #333; color: #0f0; padding: 15px; border-radius: 4px; overflow-x: auto; font-family: monospace; font-size: 12px; height: 300px; overflow-y: scroll; white-space: pre-wrap; }
        .hidden { display: none; }
        h2 { margin-top: 0; }
        .step-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h2>LeadConnector Login Flow</h2>
    
    <!-- STAGE 1: CREDENTIALS -->
    <div id="step1">
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" placeholder="jacob@example.com" value="jacob@thekairosmedia.com">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" placeholder="Password" value="">
        </div>
        <div class="form-group">
            <label>Company ID <span class="step-badge">Extracted from HAR</span></label>
            <input type="text" id="companyId" value="eRzyNWgO7fUGsvSQv7eR">
        </div>
        <button onclick="requestOtp()" id="btnStep1">Login & Send OTP</button>
    </div>

    <!-- STAGE 2: OTP VERIFICATION -->
    <div id="step2" class="hidden">
        <div class="form-group">
            <label>Enter SMS OTP</label>
            <input type="text" id="otp" placeholder="123456">
        </div>
        <button onclick="verifyOtp()" id="btnStep2">Verify & Exchange Token</button>
    </div>

    <div id="logs">Waiting for input...</div>
</div>

<script>
    // Configuration from HAR
    const BACKEND_URL = "https://backend.leadconnectorhq.com/oauth/2/login/email";
    // The key found in the final POST request in the HAR
    const GOOGLE_API_KEY = "AIzaSyB_w3vXmsI7WeQtrIOkjR6xTRVN5uOieiE"; 
    const IDENTITY_URL = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithCustomToken?key=${GOOGLE_API_KEY}`;
    
    // State storage
    let sessionToken = ""; // The UUID from Step 2
    
    function log(msg, type = 'info') {
        const logDiv = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        let color = type === 'error' ? '#ff6b6b' : (type === 'success' ? '#69db7c' : '#ffffff');
        logDiv.innerHTML += `<div style="color:${color}">[${timestamp}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(msg);
    }

    // --- STEP 2: Request OTP (Maps to Request #2 in analysis) ---
    async function requestOtp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const companyId = document.getElementById('companyId').value;

        if(!email || !password) { alert("Please fill in credentials"); return; }

        document.getElementById('btnStep1').disabled = true;
        log("Sending credentials to request OTP...", "info");

        // Payload based on HAR Connection 217902 (Request #2)
        const payload = {
            "email": email,
            "password": password,
            "companyId": companyId,
            "otpChannel": "phone", // Explicitly asking for SMS
            "domain": "app.kairoscloud.io",
            "subdomain": "app",
            "deviceId": "64df0861-7245-4d28-83d8-3bce2a138e85", // Static ID from HAR for demo purposes
            "deviceType": "web",
            "deviceName": navigator.userAgent
        };

        try {
            const response = await fetch(BACKEND_URL, {
                method: "POST",
                headers: {
                    "content-type": "application/json",
                    "channel": "APP",         // Required header from HAR
                    "source": "WEB_USER",     // Required header from HAR
                    "version": "2021-07-28"   // Required header from HAR
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            // In the HAR, this returns a "token" (UUID) which is the session ID for the OTP
            if (data.token) {
                sessionToken = data.token;
                log(`Success! Session Token (UUID) received: ${sessionToken}`, "success");
                log("Check your phone for the SMS code.", "info");
                
                // Switch UI
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
            } else {
                throw new Error("No token returned in OTP request response.");
            }

        } catch (e) {
            log(`Error requesting OTP: ${e.message}`, "error");
            document.getElementById('btnStep1').disabled = false;
        }
    }

    // --- STEP 3 & 4: Verify OTP and Exchange with Google ---
    async function verifyOtp() {
        const otp = document.getElementById('otp').value;
        if(!otp) { alert("Please enter the code"); return; }

        document.getElementById('btnStep2').disabled = true;
        log("Verifying OTP...", "info");

        // Payload based on HAR Connection 217902 (Request #3)
        const payload = {
            "email": document.getElementById('email').value,
            "password": document.getElementById('password').value,
            "companyId": document.getElementById('companyId').value,
            "otpChannel": "phone",
            "otp": otp,
            "token": sessionToken, // The UUID we saved earlier
            "domain": "app.kairoscloud.io",
            "subdomain": "app",
            "deviceId": "64df0861-7245-4d28-83d8-3bce2a138e85",
            "deviceType": "web",
            "backupCode": false
        };

        try {
            // 1. Verify with Backend to get Custom JWT
            const response = await fetch(BACKEND_URL, {
                method: "POST",
                headers: {
                    "content-type": "application/json",
                    "channel": "APP",
                    "source": "WEB_USER",
                    "version": "2021-07-28"
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Backend Error ${response.status}`);
            const data = await response.json();

            // The 'token' here is the "Firebase Custom Token" (starts with eyJ...)
            const customJwt = data.token;
            if(!customJwt) throw new Error("No custom token returned from backend.");

            log("Backend verification successful. Custom Token received.", "success");
            log(`Custom Token Prefix: ${customJwt.substring(0, 30)}...`, "info");
            log("Exchanging with Google Identity Toolkit...", "info");

            // 2. Exchange Custom JWT for Final ID Token (Google)
            const googleResponse = await fetch(IDENTITY_URL, {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({
                    token: customJwt,
                    returnSecureToken: true
                })
            });

            if (!googleResponse.ok) throw new Error(`Google Error ${googleResponse.status}`);
            const googleData = await googleResponse.json();

            const finalIdToken = googleData.idToken;

            log("\n---------------------------------------------------", "success");
            log("FINAL JWT TOKEN ACQUIRED:", "success");
            log(finalIdToken, "success");
            log("---------------------------------------------------\n", "success");

        } catch (e) {
            log(`Error during verification: ${e.message}`, "error");
            document.getElementById('btnStep2').disabled = false;
        }
    }
</script>

</body>
</html>