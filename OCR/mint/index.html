<!--
OCR Contact Card Minter
This is a static HTML/CSS/JS page that generates printable sheets of contact info cards.
Students write on these cards, and they are scanned to auto-fill their info digitally.

Layout:
- Card Dimensions: 4.25 x 3.66667 inches.
- Sheet: Prints 6 cards (2x3) on a standard A4 8.5 x 11 inch page.
- Pagination: If more than 6 cards are requested, multiple sheets are generated with page breaks.

Dynamic Data:
- Subaccount Name: Fetched via GHL API using "locationID" URL parameter and window.globalLocationAccessKey.
- Unique ID: A random base62 string of length 8. Uniqueness is statistically assumed (no database check).
- QR Code: Generated client-side using qrcodejs. Links to sites.kairoscloud.io/f/<uniqueID>.

Workflow:
1. Page loads, fetches location name.
2. Generates the default number of cards (6).
3. User can adjust the number of cards.
4. "Print" button triggers window.print().
5. After printing, the "afterprint" event saves all generated IDs to Firestore collection "cards" with the locationID.

Dependencies:
- Firebase (App, Firestore)
- globalFirebase.js (Config)
- qrcodejs (QR Generation)
-->
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Generate Contact Cards | Kairos Cloud</title>
        <link
            rel="icon"
            type="image/png"
            href="http://kairoscloud.github.io/main/Assets/favicon.png"
        />
        <!-- Firebase Dependencies -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
        <!-- QR Code Library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        <!-- Custom Configuration -->
        <script src="https://kairoscloud.github.io/main/globalFirebase.js?v3"></script>

        <style>
            @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap");

            :root {
                --card-width: 4.25in;
                --card-height: 3.66667in;
                --blue: #2d89cd;
            }

            * {
                box-sizing: border-box;
            }

            body {
                margin: 0;
                padding: 0;
                font-family: "Roboto", sans-serif;
                background-color: #f0f0f0;
            }

            /* Main Container for multiple sheets */
            #sheets-wrapper {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 40px;
                padding: 40px 0;
            }

            /* Printable Sheet */
            .sheet {
                width: 8.5in;
                height: 11in;
                background: white;
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr 1fr;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                page-break-after: always; /* Ensure new page while printing */
                break-after: page;
            }

            /* Card Layout */
            .card {
                width: var(--card-width);
                height: var(--card-height);
                padding: 0.4in;
                position: relative;
                display: flex;
                flex-direction: column;
            }

            /* Cut Lines (Dashed) */
            .card:nth-child(2n + 1) {
                border-right: 1px dashed #ccc;
            }
            /* Add border bottom to the first 4 cards (top 2 rows) */
            .card:nth-child(-n + 4) {
                border-bottom: 1px dashed #ccc;
            }

            /* Header Area */
            .header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 20px;
            }

            .logo-section {
                flex: 1;
            }

            .logo-img {
                max-width: 200px;
                height: auto;
                margin-bottom: 8px;
                display: block;
            }

            .sub-text {
                font-size: 12px;
                color: #333;
                margin-top: 5px;
            }

            .qr-section {
                text-align: center;
                margin-top: -5px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            /* QR Container for JS generation */
            .qr-code-container {
                width: 80px;
                height: 80px;
            }

            .qr-code-container img {
                display: block; /* Remove inline spacing */
            }

            .id-label {
                font-family: monospace;
                font-size: 12px;
                margin-top: 2px;
                letter-spacing: 1px;
            }

            /* Form Area */
            .form-area {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 25px;
                padding-left: 10px;
                padding-right: 10px;
            }

            .form-line {
                display: flex;
                align-items: flex-end;
                font-size: 16px;
            }

            .label {
                /* Fixed width and right align ensures lines start at same spot */
                width: 60px;
                text-align: right;
                margin-right: 15px;
                font-weight: 400;
                color: #333;
                white-space: nowrap;
            }

            .line {
                flex-grow: 1;
                border-bottom: 1px solid #000;
            }

            /* Action Button & Input */
            #action-container {
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
                background: rgba(255, 255, 255, 0.9);
                padding: 15px;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            }

            .input-group {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 5px;
                margin-bottom: 5px;
            }

            .input-group label {
                font-size: 12px;
                color: #555;
                font-weight: bold;
            }

            #card-count {
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 6px;
                width: 80px;
                font-size: 16px;
                text-align: right;
            }

            #status-text {
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 14px;
                display: none; /* Hidden by default */
            }

            #action-btn {
                background-color: var(--blue);
                color: white;
                border: none;
                padding: 15px 30px;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                border-radius: 9px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
                transition:
                    transform 0.2s,
                    background-color 0.2s;
                width: 100%;
            }

            #action-btn:hover {
                transform: translateY(-2px);
                background-color: #247bbd;
            }

            #action-btn:disabled {
                background-color: #999;
                cursor: wait;
                transform: none;
            }

            /* Print Media Query */
            @media print {
                @page {
                    size: A4;
                    margin: 0;
                }

                body {
                    background: white;
                }

                #action-container {
                    display: none;
                }

                #sheets-wrapper {
                    margin: 0;
                    padding: 0;
                    gap: 0;
                    display: block; /* Restore block for paging */
                }

                .sheet {
                    margin: 0;
                    box-shadow: none;
                    width: 100%;
                    height: 100%;
                    /* Ensure every sheet forces a new page,
                       except potentially the last one handled by browser */
                    page-break-after: always;
                    break-after: page;
                }

                .sheet:last-child {
                    page-break-after: auto;
                    break-after: auto;
                }
            }
        </style>
    </head>
    <body>
        <div id="action-container">
            <span id="status-text">Loading...</span>

            <div class="input-group">
                <label for="card-count">Total Cards</label>
                <input
                    type="number"
                    id="card-count"
                    value="6"
                    min="1"
                    step="1"
                />
            </div>

            <button id="action-btn" onclick="handleAction()" disabled>
                Loading...
            </button>
        </div>

        <div id="sheets-wrapper">
            <!-- Sheets will be injected here -->
        </div>

        <script>
            // -- Configuration --
            let generatedIds = [];
            let locationName = "Loading...";
            let hasPrinted = false;

            // -- 1. Initialization --
            document.addEventListener("DOMContentLoaded", async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const locationId = urlParams.get("locationID");
                const statusEl = document.getElementById("status-text");
                const btn = document.getElementById("action-btn");
                const countInput = document.getElementById("card-count");

                statusEl.style.display = "block";

                if (!locationId) {
                    statusEl.textContent = "Error: No locationId in URL.";
                    btn.textContent = "Error";
                    return;
                }

                try {
                    // Fetch Subaccount Info
                    locationName = await fetchLocationName(locationId);

                    // Generate Cards (Initial batch of 6)
                    await generateCards(parseInt(countInput.value) || 6);

                    // Enable Print
                    statusEl.style.display = "none";
                    btn.textContent = "Print";
                    btn.disabled = false;

                    // Add listener to regenerate when number changes
                    countInput.addEventListener("change", async (e) => {
                        const val = parseInt(e.target.value);
                        if (val > 0) {
                            btn.disabled = true;
                            btn.textContent = "Generating...";
                            await generateCards(val);
                            btn.textContent = "Print";
                            btn.disabled = false;
                        }
                    });
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = "Error: " + err.message;
                    btn.textContent = "Error";
                }
            });

            // -- 2. API Logic --
            async function fetchLocationName(locationId) {
                while (!window.GlobalLocationAccessKey) {
                    await new Promise((resolve) => setTimeout(resolve, 100));
                }

                const token = window.GlobalLocationAccessKey;

                const response = await fetch(
                    `https://services.leadconnectorhq.com/locations/${locationId}`,
                    {
                        method: "GET",
                        headers: {
                            Accept: "application/json",
                            Version: "2021-07-28",
                            Authorization: `Bearer ${token}`,
                        },
                    },
                );

                if (!response.ok)
                    throw new Error("Failed to fetch location data");

                const data = await response.json();
                return data.location
                    ? data.location.name || data.location.businessName
                    : "Unknown School";
            }

            // -- 3. Hashing & Uniqueness Logic --
            function hash(input) {
                const outputDomain =
                    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
                const magic = "jsHashSeed";

                let ac1 = 0;
                let ac2 = 0;

                let s = String(input) + typeof input + magic;

                for (let i = 0; i < s.length; i++) {
                    ac1 = (ac1 << 5) - ac1 + s.charCodeAt(i);
                    ac2 = (ac2 << 5) - ac2 + s.charCodeAt(s.length - 1 - i);
                    ac1 |= 0;
                    ac2 |= 0;
                }

                let result = "";
                for (let i = 0; i < 8; i++) {
                    let mixed = ac1 ^ (ac2 + i);
                    mixed ^= mixed >>> 17;
                    mixed ^= mixed >>> 8;
                    const index = Math.abs(mixed) % outputDomain.length;
                    result += outputDomain[index];
                    ac1 = ((ac1 << 3) - ac1) ^ ac2;
                    ac1 |= 0;
                    ac2 = ((ac2 << 3) - ac2) ^ ac1;
                    ac2 |= 0;
                }
                return result;
            }

            function getUniqueId() {
                // Modified: removed Firestore check for speed on large batches
                return hash(Math.random() + new Date().getTime());
            }

            // -- 4. DOM Generation --
            async function generateCards(count) {
                const wrapper = document.getElementById("sheets-wrapper");
                wrapper.innerHTML = "";
                generatedIds = []; // Reset list

                let currentSheet = null;

                for (let i = 0; i < count; i++) {
                    // Create a new sheet every 6 cards
                    if (i % 6 === 0) {
                        currentSheet = document.createElement("div");
                        currentSheet.className = "sheet";
                        wrapper.appendChild(currentSheet);
                    }

                    const uniqueID = getUniqueId();
                    generatedIds.push(uniqueID);

                    // Card container
                    const cardDiv = document.createElement("div");
                    cardDiv.className = "card";

                    cardDiv.innerHTML = `
                        <div class="header">
                            <div class="logo-section">
                                <img src="https://kairoscloud.github.io/main/Assets/lax0ZXTk.png" class="logo-img" alt="Kairos Cloud">
                                <div class="sub-text">${locationName} | School Contact Form</div>
                            </div>
                            <div class="qr-section">
                                <div id="qr-${uniqueID}" class="qr-code-container"></div>
                                <div class="id-label">ID_${uniqueID}</div>
                            </div>
                        </div>
                        <div class="form-area">
                            <div class="form-line">
                                <span class="label">Name</span>
                                <div class="line"></div>
                            </div>
                            <div class="form-line">
                                <span class="label">Phone</span>
                                <div class="line"></div>
                            </div>
                            <div class="form-line">
                                <span class="label">Email</span>
                                <div class="line"></div>
                            </div>
                        </div>
                    `;

                    currentSheet.appendChild(cardDiv);

                    // Generate QR Code Client-Side
                    // We must wait for the element to be in the DOM (it is, via appendChild)
                    new QRCode(document.getElementById(`qr-${uniqueID}`), {
                        text: `https://sites.kairoscloud.io/f/${uniqueID}`,
                        width: 80,
                        height: 80,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.L,
                    });
                }
            }

            // -- 5. Printing & Saving --
            function handleAction() {
                if (hasPrinted) {
                    // If already printed, refresh the page to start over
                    window.location.reload();
                } else {
                    // Trigger print
                    window.print();
                }
            }

            // Listen for afterprint event to save to Firebase
            window.addEventListener("afterprint", async (event) => {
                const statusEl = document.getElementById("status-text");
                const btn = document.getElementById("action-btn");

                statusEl.style.display = "block";
                statusEl.textContent = "Saving records...";
                btn.disabled = true;

                try {
                    const locationParam = new URLSearchParams(
                        window.location.search,
                    ).get("locationID");

                    // Process in batches of 500 (Firestore batch limit)
                    const chunks = [];
                    for (let i = 0; i < generatedIds.length; i += 400) {
                        chunks.push(generatedIds.slice(i, i + 400));
                    }

                    for (const chunk of chunks) {
                        const batch = firestore.batch();
                        chunk.forEach((id) => {
                            const docRef = firestore
                                .collection("cards")
                                .doc(id);
                            batch.set(docRef, {
                                locationID: locationParam,
                            });
                        });
                        await batch.commit();
                    }

                    // Update UI state
                    statusEl.textContent = `Saved ${generatedIds.length} cards successfully!`;
                    setTimeout(() => {
                        statusEl.style.display = "none";
                    }, 3000);

                    hasPrinted = true;
                    btn.textContent = "Print More";
                    btn.disabled = false;
                } catch (error) {
                    console.error("Error saving to firestore:", error);
                    statusEl.textContent = "Error saving records.";
                    btn.disabled = false;
                }
            });
        </script>
    </body>
</html>
