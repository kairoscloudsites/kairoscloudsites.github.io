<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>OCR Demo - Multi-Card & PDF</title>

        <!-- Firebase Dependencies -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
        <!-- Custom Global Firebase Init Script -->
        <script src="https://kairoscloud.github.io/main/globalFirebase.js?v3"></script>

        <!-- JWT Library for Google Auth -->
        <script src="https://kjur.github.io/jsrsasign/jsrsasign-all-min.js"></script>

        <!-- PDF.js for PDF Rendering -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
        <script>
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
        </script>

        <style>
            * {
                box-sizing: border-box;
            }

            html,
            body {
                margin: 0;
                padding: 0;
                height: 100%;
                width: 100%;
                overflow: hidden;
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
                background-color: #121212;
                color: #e0e0e0;
            }

            .container {
                display: flex;
                width: 100vw;
                height: 100vh;
            }

            .panel {
                flex: 1;
                height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            #left-panel {
                position: relative;
                background-color: #000;
                border-right: 1px solid #333;
                align-items: center;
                justify-content: center;
            }

            #right-panel {
                background-color: #1e1e1e;
                padding: 30px;
                overflow-y: auto;
            }

            #camera-view {
                width: 100%;
                height: 100%;
                object-fit: cover;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1;
            }

            /* Controls Overlay */
            .controls-overlay {
                position: absolute;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 15px;
                z-index: 10;
                width: 90%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .btn {
                padding: 12px 24px;
                font-size: 16px;
                font-weight: bold;
                color: #fff;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            }

            #capture-btn {
                background-color: rgba(26, 115, 232, 0.9);
            }
            #capture-btn:hover {
                background-color: rgba(26, 115, 232, 1);
            }

            /* File Upload Styling */
            .file-upload-wrapper {
                position: relative;
                overflow: hidden;
                display: inline-block;
            }
            .file-upload-wrapper input[type="file"] {
                font-size: 100px;
                position: absolute;
                left: 0;
                top: 0;
                opacity: 0;
                cursor: pointer;
            }
            #upload-btn {
                background-color: rgba(255, 152, 0, 0.9);
            }
            #upload-btn:hover {
                background-color: rgba(255, 152, 0, 1);
            }

            .btn:disabled {
                background-color: #5f6368 !important; /* Force override for validation state */
                cursor: not-allowed;
                opacity: 0.7;
            }

            /* Form Styles */
            h2 {
                margin-top: 0;
                color: #fff;
                margin-bottom: 20px;
                border-bottom: 1px solid #333;
                padding-bottom: 10px;
            }

            /* Card Item Container - Updated for Side-by-Side */
            .card-entry {
                background-color: #252525;
                border: 1px solid #333;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 25px;
                position: relative;
                display: flex; /* Flexbox for side-by-side */
                flex-wrap: wrap; /* Wrap on small screens */
                gap: 20px;
            }

            .card-entry-header {
                position: absolute;
                top: 0;
                right: 0;
                background: #333;
                padding: 5px 10px;
                font-size: 12px;
                border-bottom-left-radius: 8px;
                border-top-right-radius: 8px;
                color: #aaa;
                z-index: 5;
            }

            .card-image-col {
                flex: 1;
                min-width: 200px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .card-image-col img {
                width: 100%;
                height: auto;
                border-radius: 4px;
                border: 1px solid #444;
                object-fit: contain;
                max-height: 300px;
                background: #000;
            }

            .card-form-col {
                flex: 2;
                min-width: 250px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            label {
                display: block;
                margin-bottom: 6px;
                font-weight: 500;
                color: #aaa;
                font-size: 13px;
            }

            input[type="text"],
            input[type="email"],
            input[type="tel"] {
                width: 100%;
                padding: 10px;
                background-color: #1a1a1a;
                border: 1px solid #444;
                border-radius: 4px;
                color: #fff;
                font-size: 14px;
                transition:
                    border-color 0.3s,
                    box-shadow 0.3s;
            }

            input:focus {
                outline: none;
                border-color: #2196f3;
            }

            /* Validation Styling */
            input.invalid {
                border-color: #f44336 !important;
                background-color: rgba(244, 67, 54, 0.1);
            }

            .checkbox-group {
                display: flex;
                align-items: center;
                margin-bottom: 25px;
                background: #2a2a2a;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid #444;
            }

            .checkbox-group input {
                margin-right: 10px;
                width: 18px;
                height: 18px;
            }

            .checkbox-group label {
                margin-bottom: 0;
                color: #fff;
                cursor: pointer;
            }

            #save-all-btn {
                width: 100%;
                padding: 15px;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                transition: background-color 0.2s;
                margin-bottom: 10px;
            }

            #save-all-btn:hover {
                background-color: #43a047;
            }

            #save-all-btn:disabled {
                background-color: #555;
                cursor: not-allowed;
            }

            .status-msg {
                margin-top: 15px;
                padding: 10px;
                border-radius: 4px;
                text-align: center;
                display: none;
                white-space: pre-wrap; /* allow multiline errors */
            }
            .status-success {
                background-color: rgba(76, 175, 80, 0.2);
                color: #81c784;
            }
            .status-error {
                background-color: rgba(244, 67, 54, 0.2);
                color: #e57373;
            }

            #cards-container {
                margin-bottom: 20px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="panel" id="left-panel">
                <video id="camera-view" autoplay playsinline></video>

                <div class="controls-overlay">
                    <button id="capture-btn" class="btn">Capture Camera</button>
                    <div class="file-upload-wrapper">
                        <button id="upload-btn" class="btn">
                            Upload PDF / Images
                        </button>
                        <input
                            type="file"
                            id="file-input"
                            accept="application/pdf,image/*"
                            multiple
                        />
                    </div>
                </div>
            </div>

            <div class="panel" id="right-panel">
                <h2>Extracted Details</h2>

                <div id="cards-container">
                    <!-- Dynamic cards will appear here -->
                    <p style="color: #666; font-style: italic">
                        Scan a card or upload a PDF to begin.
                    </p>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="chk-create-contact" checked />
                    <label for="chk-create-contact"
                        >Create/Upsert Contacts</label
                    >
                </div>

                <button id="save-all-btn" class="btn" disabled>
                    Save All to Database
                </button>
                <div id="status-display" class="status-msg"></div>
            </div>
        </div>

        <!-- Hidden canvas for processing -->
        <canvas id="process-canvas" style="display: none"></canvas>

        <script>
            // --- DOM Elements ---
            const video = document.getElementById("camera-view");
            const canvas = document.getElementById("process-canvas");
            const captureBtn = document.getElementById("capture-btn");
            const uploadBtn = document.getElementById("upload-btn"); // Visual button
            const fileInput = document.getElementById("file-input");
            const saveBtn = document.getElementById("save-all-btn");
            const statusDisplay = document.getElementById("status-display");
            const cardsContainer = document.getElementById("cards-container");
            const chkCreateContact =
                document.getElementById("chk-create-contact");

            // --- Gemini API Logic ---
            let keys = [
                atob("QUl6YVN5QWZsdzZIWDVOblg4NFZZZE9UcHBSc0t4NG9ZdE9VVGRr"),
            ];

            async function ai(prompt, model, retries, apiKey) {
                try {
                    if (!retries) retries = 0;
                    if (!apiKey) apiKey = keys[retries % keys.length];
                    if (!model) model = "gemini-2.5-flash-lite";

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    let requestBody = {
                        contents: [{ parts: [{ text: prompt }] }],
                    };

                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(requestBody),
                    });

                    if (response.status === 429) {
                        await new Promise((resolve) =>
                            setTimeout(resolve, 700),
                        );
                        return ai(prompt, model, retries + 1);
                    }

                    if (!response.ok)
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("AI Error:", error);
                    throw error;
                }
            }

            // --- Google Cloud Credentials (Vision API) ---
            const serviceAccountCreds = {
                type: "service_account",
                project_id: "kairos-test-eedd6",
                private_key_id: "ef063c7ce426ad5232ce9433862ecc49f42bfa8e",
                private_key:
                    "-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCOSytUpH2Kgai8\nsHv/uVBs99fP/s4NOhx1Cf84rrj05gsmtxOQmnd9XbRwHwlU7b17zMjv3hrtnP0X\na1JQNcWIy5PiyzEJOCG8vqr/0bfh4/KqSlxI+srRTZGYuxM9H5TvwTyDx9Nr//vQ\nurX3d4IRKmVJ3vkfltlRedIkoTMDtFjlD2KQ08nV00aT6siLbOzr6mDzrIYJVibi\nRBIMIntCrRdUgf3AJrxh2fVXMqc5ffzFj/4hofzwulNUyWj9SFg/yjEFE9HbGDbF\nLXKbgDicVe2ocdFYlo6+ejrUH3hL5VnvuajOF76VeB8BPyR7D9FnCWYEk1NkZmxQ\nLvNI2iqHAgMBAAECggEAEheDS4sb3dpye9tB84JlCWsnE25lqyTdAryMqMZTrz+j\nN1RGYTe37ZwBGdMNurCnoO/+tGYxrPiC7XwFxpEFAUmbugBKcc5N69OfplB3PXoK\nxpVsemhOFU1JhSPJZGzO4P+uvrVPhQcnxfhCCVQ2mLwijhaS55ikdPQ06yyxHHfx\n3Uy5dzzSYBh/WZuDGF7Bwl2go8NsjCbiQNfGOtS8sFheFgSMJL2M+Er70a9BrQXl\neANIFBbGRhAK+rijZQ7PpvJ22mio4ztbNw1vIr/VqaBklhEffEGnrzwfnl8x2HiC\n2khrpcyxFrCdYLfIf/N0HGtL1PvMOYn8AAdEJswXIQKBgQDCdwyWYYfWMSPptenY\nAGU+3XzywQWSZC+XNfNQc0PzZW0ryifx0DnXNX3Ro5saMod4DoLi1cHIEwZ8o+/9\nk7gyw0zO84X+Wsc5tDZfjh9wAkImd/wfFDlUMqHWUQPXvkrgco4Kk5JZQUYtRxuz\nF7HbOvvWAfdg8Onber33LytQuQKBgQC7UeRb3Vc/vtAw/gfsOZ66X07MzP/0lG9C\nMxA0xGyq5UQ6fD2ssvDBMRzzPe7Sg0d3nA3Hm3Yz8Gm5eyNAmDbDYvyPSSK6lBLa\nn8N+8aL3tKkk5i6JUqVTbLLYEyaZQGBuDmhT6hmIXxm2Xw/Ydb2RaAVcty/JkdV9\nnyBIFdM1PwKBgCtyUZufequ+GtnyTKZ3oCclcO8DdO05+O/9m7jTp9DPTk7EQZxi\n+yk7yDp4JQT7WQzXoSJww3Sh24cpUUsEH9knjReHjN5BBdW8j5FVvWxW9NSHZgrD\nh/NpxIKPYx5mY3A158oxIjdSwA0JoASpPJFQYkdz9QLxkC37BEoffbvxAoGAHgdQ\nvlFLTVK/eTsf9gR+p43jyf0LAyBQfaJF9M+QRA0g1OdZ07eT1MSUyYGiKWkWKdyA\ncQFA/66IpE1TJ2W/Ua8qoaWtxY87PoTiCBWgdGknvFySFT2Ed00zlmPriiHB06LH\norwif7QPISc4GRE25HpycZyEMqIIQW0i9ataAm0CgYBgjvolBRXCbeIe4HLb8UdU\nzl7khBu437qUsgxBbpmqLvEcdxciG+itbO8rO5oONeRW6zyKrSAMNm8Z3fVU6eBE\nS7QxHEsrVI7iUJQG+hNA5yEUeKt95AUc64u6KYS+sJ0BfzXHV6E+3Mb7gW9H1aJV\nNPfHoZ/GpFtTmdaTwEx9cQ==\n-----END PRIVATE KEY-----\n",
                client_email:
                    "cloudvision-kairos@kairos-test-eedd6.iam.gserviceaccount.com",
                token_uri: "https://oauth2.googleapis.com/token",
            };
            const visionApiEndpoint =
                "https://vision.googleapis.com/v1/images:annotate";
            let accessToken = null;
            let tokenExpiry = null;

            async function getAccessToken() {
                if (accessToken && tokenExpiry && new Date() < tokenExpiry)
                    return accessToken;
                const header = { alg: "RS256", typ: "JWT" };
                const now = Math.floor(Date.now() / 1000);
                const claimSet = {
                    iss: serviceAccountCreds.client_email,
                    scope: "https://www.googleapis.com/auth/cloud-vision",
                    aud: serviceAccountCreds.token_uri,
                    exp: now + 3600,
                    iat: now,
                };
                const signedJWT = KJUR.jws.JWS.sign(
                    "RS256",
                    JSON.stringify(header),
                    JSON.stringify(claimSet),
                    serviceAccountCreds.private_key,
                );
                const response = await fetch(serviceAccountCreds.token_uri, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${signedJWT}`,
                });
                const data = await response.json();
                accessToken = data.access_token;
                tokenExpiry = new Date(now * 1000 + data.expires_in * 1000);
                return accessToken;
            }

            // --- Camera & Setup ---
            async function initCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" },
                    });
                    video.srcObject = stream;
                } catch (err) {
                    console.error("Camera access error:", err);
                }
            }

            // --- Processing Logic ---
            function setProcessing(isProcessing, msg = "Processing...") {
                captureBtn.disabled = isProcessing;
                uploadBtn.disabled = isProcessing;
                fileInput.disabled = isProcessing;
                saveBtn.disabled = isProcessing;

                // Keep original text when not processing
                if (!isProcessing) {
                    captureBtn.textContent = "Capture Camera";
                    uploadBtn.textContent = "Upload PDF / Images";
                } else {
                    captureBtn.textContent = msg;
                    uploadBtn.textContent = msg;
                }
            }

            // 1. Handle File Selection (PDF or Image)
            fileInput.addEventListener("change", async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                setProcessing(true, "Processing Files...");
                statusDisplay.style.display = "none";
                cardsContainer.innerHTML =
                    '<p style="color:#aaa;">Loading documents...</p>';

                try {
                    let base64Images = [];

                    for (let file of files) {
                        if (file.type === "application/pdf") {
                            const pdfImages = await processPdf(file);
                            base64Images.push(...pdfImages);
                        } else if (file.type.startsWith("image/")) {
                            const imgBase64 = await processImageFile(file);
                            base64Images.push(imgBase64);
                        }
                    }

                    if (base64Images.length === 0)
                        throw new Error("No valid images found.");

                    await runOcrBatch(base64Images);
                } catch (err) {
                    console.error(err);
                    statusDisplay.textContent = "File Error: " + err.message;
                    statusDisplay.className = "status-msg status-error";
                    statusDisplay.style.display = "block";
                } finally {
                    setProcessing(false);
                    // Reset input so change event fires again if same file selected
                    fileInput.value = "";
                }
            });

            // Helper: PDF to Base64 Images
            async function processPdf(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const images = [];

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 }); // Good scale for OCR
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const ctx = canvas.getContext("2d");

                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport,
                    }).promise;
                    images.push(canvas.toDataURL("image/jpeg").split(",")[1]);
                }
                return images;
            }

            // Helper: Image File to Base64
            function processImageFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Strip header for Vision API
                        const b64 = e.target.result.split(",")[1];
                        resolve(b64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // 2. Handle Camera Capture
            captureBtn.addEventListener("click", async () => {
                setProcessing(true, "Processing Camera...");
                statusDisplay.style.display = "none";

                try {
                    const ctx = canvas.getContext("2d");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const base64 = canvas.toDataURL("image/jpeg").split(",")[1];

                    await runOcrBatch([base64]);
                } catch (err) {
                    console.error(err);
                    alert("Camera Error: " + err.message);
                } finally {
                    setProcessing(false);
                }
            });

            // 3. Core Logic: Batch OCR -> Gemini
            async function runOcrBatch(base64Array) {
                cardsContainer.innerHTML =
                    '<p style="color:#2196f3;">Running OCR on ' +
                    base64Array.length +
                    " image(s)...</p>";

                const token = await getAccessToken();
                let fullRawText = "";
                let endOcrCount = 0;

                for (let i = 0; i < base64Array.length; i++) {
                    const b64 = base64Array[i];

                    const response = await fetch(visionApiEndpoint, {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json; charset=utf-8",
                        },
                        body: JSON.stringify({
                            requests: [
                                {
                                    image: { content: b64 },
                                    features: [{ type: "TEXT_DETECTION" }],
                                    imageContext: { languageHints: ["en"] },
                                },
                            ],
                        }),
                    });

                    if (!response.ok)
                        throw new Error(
                            "Vision API failed on image " + (i + 1),
                        );
                    const data = await response.json();
                    const text =
                        data.responses[0]?.fullTextAnnotation?.text || "";

                    // Append with delimiter
                    fullRawText += `\n--- PAGE ${i + 1} START ---\n${text}\n[End OCR]\n`;
                    endOcrCount++;
                }

                cardsContainer.innerHTML =
                    '<p style="color:#2196f3;">Parsing data with AI...</p>';

                const prompt = `You are processing OCR raw output from ${endOcrCount} distinct card(s) or page(s).
There are exactly ${endOcrCount} occurrences of "[End OCR]" in the text below, signifying the separation of data.

Task: Extract contact details for EACH card/page into a JSON ARRAY.
Schema for each object in array:
{
    "id": "<id or null>",
    "name": "<name or null>",
    "phone_number": "<phone or null>",
    "email": "<email or null>"
}

Raw Data:
${fullRawText}

Return ONLY the valid JSON Array. Do not wrap in markdown.
Ensure phone numbers are formatted in E.164 (+1XXXXXXXXXX).
`;
                const geminiResp = await ai(prompt);

                let parsedArray = [];
                try {
                    const cleanJson = geminiResp
                        .replace(/```json/g, "")
                        .replace(/```/g, "")
                        .trim();
                    parsedArray = JSON.parse(cleanJson);
                    if (!Array.isArray(parsedArray)) {
                        parsedArray = [parsedArray];
                    }
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    throw new Error("AI response was not valid JSON.");
                }

                // Pass the images down to the renderer
                renderCards(parsedArray, base64Array);
            }

            // --- Validation Logic ---
            function isValidId(val) {
                const re = /^[a-zA-Z0-9]{8}$/;
                return re.test(val);
            }

            function isValidName(val) {
                return val && val.trim().length > 0;
            }

            function validateForms() {
                const cardEntries = document.querySelectorAll(".card-entry");
                let allCardsValid = true;

                cardEntries.forEach((card) => {
                    const idInput = card.querySelector(".inp-id");
                    const nameInput = card.querySelector(".inp-name");
                    const idValid = isValidId(idInput.value);
                    const nameValid = isValidName(nameInput.value);

                    idInput.classList.toggle("invalid", !idValid);
                    nameInput.classList.toggle("invalid", !nameValid);

                    if (!idValid || !nameValid) allCardsValid = false;
                });

                if (allCardsValid && cardEntries.length > 0) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = "Upsert";
                } else {
                    saveBtn.disabled = true;
                    saveBtn.textContent = "Review Data Entries";
                }
            }

            // 4. Render Dynamic Forms
            function renderCards(dataArray, imageArray) {
                cardsContainer.innerHTML = "";
                if (!dataArray || dataArray.length === 0) return;

                dataArray.forEach((data, index) => {
                    // Get corresponding image (assuming 1-to-1 mapping)
                    const imgBase64 = imageArray[index] || "";
                    const imgSrc = imgBase64
                        ? `data:image/jpeg;base64,${imgBase64}`
                        : "";

                    const div = document.createElement("div");
                    div.className = "card-entry";
                    div.innerHTML = `
                        <div class="card-entry-header">Card ${index + 1}</div>

                        <!-- Left Col: Image -->
                        <div class="card-image-col">
                             ${imgSrc ? `<img src="${imgSrc}" alt="Scanned Card Page ${index + 1}" />` : "<p>No Image</p>"}
                        </div>

                        <!-- Right Col: Form -->
                        <div class="card-form-col">
                            <div class="form-group">
                                <label>Card Unique ID *</label>
                                <input type="text" class="inp-id" value="${data.id || ""}" placeholder="8-char ID" autocomplete="off" />
                            </div>
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" class="inp-name" value="${data.name || ""}" placeholder="Full Name" autocomplete="off" />
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" class="inp-phone" value="${data.phone_number || ""}" placeholder="+15550001234" autocomplete="off" />
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" class="inp-email" value="${data.email || ""}" placeholder="email@example.com" autocomplete="off" />
                            </div>
                        </div>
                    `;
                    cardsContainer.appendChild(div);
                    div.querySelectorAll("input").forEach((input) =>
                        input.addEventListener("input", validateForms),
                    );
                });
                validateForms();
            }

            // 5. Save/Upsert Logic
            saveBtn.addEventListener("click", async () => {
                if (saveBtn.disabled) return;
                saveBtn.disabled = true;
                saveBtn.textContent = "Upserting...";
                statusDisplay.style.display = "none";

                const entries = document.querySelectorAll(".card-entry");
                const locationID =
                    new URLSearchParams(window.location.search).get(
                        "locationID",
                    ) || "";

                let successCount = 0;
                let errorLog = "";

                for (let i = 0; i < entries.length; i++) {
                    const card = entries[i];
                    const id = card.querySelector(".inp-id").value.trim();
                    const name = card.querySelector(".inp-name").value.trim();
                    const phone = card.querySelector(".inp-phone").value.trim();
                    const email = card.querySelector(".inp-email").value.trim();

                    try {
                        let contactID = "";
                        if (chkCreateContact.checked) {
                            contactID = await upsertGHLContact(
                                { name, phone, email },
                                locationID,
                            );
                        }

                        await firestore.collection("cards").doc(id).set(
                            {
                                name,
                                phone,
                                email,
                                contactID,
                                locationID,
                                added: Date.now(),
                            },
                            { merge: true },
                        );
                        successCount++;
                    } catch (e) {
                        errorLog += `Card ${i + 1}: ${e.message}\n`;
                    }
                }

                if (successCount === entries.length) {
                    statusDisplay.className = "status-msg status-success";
                    statusDisplay.textContent = `Upserted ${successCount} contacts successfully!`;
                    saveBtn.textContent = "Upsert Complete";
                } else {
                    statusDisplay.className = "status-msg status-error";
                    statusDisplay.textContent = `Completed ${successCount}/${entries.length}.\nErrors:\n${errorLog}`;
                    saveBtn.disabled = false;
                    saveBtn.textContent = "Retry Upsert";
                }
                statusDisplay.style.display = "block";
            });

            // --- GHL Helper Updated for Upsert ---
            async function upsertGHLContact(contactData, locationID) {
                const ghlToken = window.GlobalLocationAccessKey;
                if (!ghlToken || !locationID)
                    throw new Error("Missing Auth/Location ID");

                const payload = {
                    locationId: locationID,
                    name: contactData.name.trim(),
                    email: contactData.email || undefined,
                    phone: contactData.phone || undefined,
                    tags: ["student-card-scan"],
                    source: "OCR App",
                };

                const response = await fetch(
                    "https://services.leadconnectorhq.com/contacts/upsert",
                    {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${ghlToken}`,
                            Version: "2021-07-28",
                            "Content-Type": "application/json",
                            Accept: "application/json",
                        },
                        body: JSON.stringify(payload),
                    },
                );

                if (!response.ok) {
                    const errBody = await response.json().catch(() => ({}));
                    throw new Error(
                        `GHL Upsert Failed: ${response.status} ${JSON.stringify(errBody)}`,
                    );
                }
                const result = await response.json();
                return result.contact?.id;
            }

            window.addEventListener("load", initCamera);
        </script>
    </body>
</html>
