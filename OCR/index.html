<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Camera OCR</title>
        <style>
            * {
                box-sizing: border-box;
            }

            html,
            body {
                margin: 0;
                padding: 0;
                height: 100%;
                width: 100%;
                overflow: hidden;
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
                background-color: #121212;
                color: #e0e0e0;
            }

            .container {
                display: flex;
                width: 100vw;
                height: 100vh;
            }

            .panel {
                flex: 1;
                height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            #left-panel {
                position: relative;
                background-color: #000;
            }

            #right-panel {
                background-color: #1e1e1e;
                padding: 20px;
            }

            #camera-view {
                width: 100%;
                height: 100%;
                object-fit: cover; /* Cover the entire panel */
            }

            #capture-btn {
                position: absolute;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                padding: 15px 30px;
                font-size: 18px;
                font-weight: bold;
                color: #fff;
                background-color: rgba(26, 115, 232, 0.9);
                border: none;
                border-radius: 50px;
                cursor: pointer;
                transition:
                    background-color 0.3s ease,
                    transform 0.1s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            }

            #capture-btn:hover {
                background-color: rgba(26, 115, 232, 1);
            }

            #capture-btn:active {
                transform: translateX(-50%) scale(0.98);
            }

            #capture-btn:disabled {
                background-color: #5f6368;
                cursor: not-allowed;
            }

            #result-text {
                white-space: pre-wrap;
                word-wrap: break-word;
                background-color: #2a2a2a;
                border: 1px solid #444;
                border-radius: 8px;
                padding: 15px;
                height: 100%;
                overflow-y: auto;
                flex-grow: 1;
                font-size: 16px;
                line-height: 1.6;
                color: #f1f1f1;
            }
        </style>
        <!-- We need a library to sign the JWT for service account authentication -->
        <script src="https://kjur.github.io/jsrsasign/jsrsasign-all-min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="panel" id="left-panel">
                <video id="camera-view" autoplay playsinline></video>
                <button id="capture-btn">Freeze and Recognize</button>
            </div>
            <div class="panel" id="right-panel">
                <pre id="result-text">
Point your camera at some text and click the button.</pre
                >
            </div>
        </div>

        <!-- Hidden canvas to capture a frame from the video -->
        <canvas id="snapshot-canvas" style="display: none"></canvas>

        <script>
            // --- DOM Elements ---
            const video = document.getElementById("camera-view");
            const canvas = document.getElementById("snapshot-canvas");
            const captureBtn = document.getElementById("capture-btn");
            const resultText = document.getElementById("result-text");

            // --- Google Cloud Credentials (INSECURE - FOR DEMO ONLY) ---
            const serviceAccountCreds = {
                type: "service_account",
                project_id: "kairos-test-eedd6",
                private_key_id: "ef063c7ce426ad5232ce9433862ecc49f42bfa8e",
                private_key:
                    "-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCOSytUpH2Kgai8\nsHv/uVBs99fP/s4NOhx1Cf84rrj05gsmtxOQmnd9XbRwHwlU7b17zMjv3hrtnP0X\na1JQNcWIy5PiyzEJOCG8vqr/0bfh4/KqSlxI+srRTZGYuxM9H5TvwTyDx9Nr//vQ\nurX3d4IRKmVJ3vkfltlRedIkoTMDtFjlD2KQ08nV00aT6siLbOzr6mDzrIYJVibi\nRBIMIntCrRdUgf3AJrxh2fVXMqc5ffzFj/4hofzwulNUyWj9SFg/yjEFE9HbGDbF\nLXKbgDicVe2ocdFYlo6+ejrUH3hL5VnvuajOF76VeB8BPyR7D9FnCWYEk1NkZmxQ\nLvNI2iqHAgMBAAECggEAEheDS4sb3dpye9tB84JlCWsnE25lqyTdAryMqMZTrz+j\nN1RGYTe37ZwBGdMNurCnoO/+tGYxrPiC7XwFxpEFAUmbugBKcc5N69OfplB3PXoK\nxpVsemhOFU1JhSPJZGzO4P+uvrVPhQcnxfhCCVQ2mLwijhaS55ikdPQ06yyxHHfx\n3Uy5dzzSYBh/WZuDGF7Bwl2go8NsjCbiQNfGOtS8sFheFgSMJL2M+Er70a9BrQXl\neANIFBbGRhAK+rijZQ7PpvJ22mio4ztbNw1vIr/VqaBklhEffEGnrzwfnl8x2HiC\n2khrpcyxFrCdYLfIf/N0HGtL1PvMOYn8AAdEJswXIQKBgQDCdwyWYYfWMSPptenY\nAGU+3XzywQWSZC+XNfNQc0PzZW0ryifx0DnXNX3Ro5saMod4DoLi1cHIEwZ8o+/9\nk7gyw0zO84X+Wsc5tDZfjh9wAkImd/wfFDlUMqHWUQPXvkrgco4Kk5JZQUYtRxuz\nF7HbOvvWAfdg8Onber33LytQuQKBgQC7UeRb3Vc/vtAw/gfsOZ66X07MzP/0lG9C\nMxA0xGyq5UQ6fD2ssvDBMRzzPe7Sg0d3nA3Hm3Yz8Gm5eyNAmDbDYvyPSSK6lBLa\nn8N+8aL3tKkk5i6JUqVTbLLYEyaZQGBuDmhT6hmIXxm2Xw/Ydb2RaAVcty/JkdV9\nnyBIFdM1PwKBgCtyUZufequ+GtnyTKZ3oCclcO8DdO05+O/9m7jTp9DPTk7EQZxi\n+yk7yDp4JQT7WQzXoSJww3Sh24cpUUsEH9knjReHjN5BBdW8j5FVvWxW9NSHZgrD\nh/NpxIKPYx5mY3A158oxIjdSwA0JoASpPJFQYkdz9QLxkC37BEoffbvxAoGAHgdQ\nvlFLTVK/eTsf9gR+p43jyf0LAyBQfaJF9M+QRA0g1OdZ07eT1MSUyYGiKWkWKdyA\ncQFA/66IpE1TJ2W/Ua8qoaWtxY87PoTiCBWgdGknvFySFT2Ed00zlmPriiHB06LH\norwif7QPISc4GRE25HpycZyEMqIIQW0i9ataAm0CgYBgjvolBRXCbeIe4HLb8UdU\nzl7khBu437qUsgxBbpmqLvEcdxciG+itbO8rO5oONeRW6zyKrSAMNm8Z3fVU6eBE\nS7QxHEsrVI7iUJQG+hNA5yEUeKt95AUc64u6KYS+sJ0BfzXHV6E+3Mb7gW9H1aJV\nNPfHoZ/GpFtTmdaTwEx9cQ==\n-----END PRIVATE KEY-----\n",
                client_email:
                    "cloudvision-kairos@kairos-test-eedd6.iam.gserviceaccount.com",
                token_uri: "https://oauth2.googleapis.com/token",
            };
            const visionApiEndpoint =
                "https://vision.googleapis.com/v1/images:annotate";
            let accessToken = null;
            let tokenExpiry = null;

            // --- Camera Initialization ---
            async function initCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }, // Prefer the rear camera
                    });
                    video.srcObject = stream;
                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    alert(
                        "Could not access the camera. Please ensure you have a camera and have granted permission.",
                    );
                }
            }

            /**
             * Generates a short-lived access token for the Vision API using a JWT.
             */
            async function getAccessToken() {
                if (accessToken && tokenExpiry && new Date() < tokenExpiry) {
                    return accessToken;
                }
                const header = { alg: "RS256", typ: "JWT" };
                const now = Math.floor(Date.now() / 1000);
                const expiry = now + 3600; // Token is valid for 1 hour
                const claimSet = {
                    iss: serviceAccountCreds.client_email,
                    scope: "https://www.googleapis.com/auth/cloud-vision",
                    aud: serviceAccountCreds.token_uri,
                    exp: expiry,
                    iat: now,
                };
                const sHeader = JSON.stringify(header);
                const sPayload = JSON.stringify(claimSet);
                const signedJWT = KJUR.jws.JWS.sign(
                    "RS256",
                    sHeader,
                    sPayload,
                    serviceAccountCreds.private_key,
                );

                try {
                    const response = await fetch(
                        serviceAccountCreds.token_uri,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type":
                                    "application/x-www-form-urlencoded",
                            },
                            body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${signedJWT}`,
                        },
                    );
                    if (!response.ok)
                        throw new Error("Failed to fetch access token");
                    const data = await response.json();
                    accessToken = data.access_token;
                    tokenExpiry = new Date(now * 1000 + data.expires_in * 1000);
                    return accessToken;
                } catch (error) {
                    console.error("Error getting access token:", error);
                    throw error;
                }
            }

            /**
             * Captures a frame, sends it to the Vision API, and displays the result.
             */
            async function freezeAndRecognize() {
                captureBtn.disabled = true;
                captureBtn.textContent = "Recognizing...";
                resultText.textContent = "Processing image...";

                // 1. Capture frame to canvas
                const context = canvas.getContext("2d");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Reverse the previous behavior: draw the image without the horizontal mirror
                // (the API will now receive the image mirrored from what the original code sent)
                context.save();
                context.setTransform(1, 0, 0, 1, 0, 0); // reset any transforms
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                context.restore();

                // 2. Get image data as Base64 (and remove the data URL prefix)
                const base64ImageData = canvas
                    .toDataURL("image/jpeg")
                    .split(",")[1];

                try {
                    // 3. Get a valid access token
                    const token = await getAccessToken();

                    // 4. Construct the Vision API request (set language to English)
                    const requestBody = {
                        requests: [
                            {
                                image: { content: base64ImageData },
                                features: [{ type: "TEXT_DETECTION" }],
                                imageContext: {
                                    languageHints: ["en"],
                                },
                            },
                        ],
                    };

                    // 5. Call the Vision API
                    const response = await fetch(visionApiEndpoint, {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json; charset=utf-8",
                        },
                        body: JSON.stringify(requestBody),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(
                            `Google Vision API error: ${error.error.message || response.statusText}`,
                        );
                    }

                    const data = await response.json();

                    // 6. Display the result
                    const detection = data.responses[0];
                    if (detection && detection.fullTextAnnotation) {
                        resultText.textContent =
                            detection.fullTextAnnotation.text;
                    } else {
                        resultText.textContent = "No text found in the image.";
                    }
                } catch (error) {
                    console.error("OCR failed:", error);
                    resultText.textContent = `Error: ${error.message}`;
                } finally {
                    // 7. Re-enable the button
                    captureBtn.disabled = false;
                    captureBtn.textContent = "Freeze and Recognize";
                }
            }

            // --- Event Listeners ---
            window.addEventListener("load", initCamera);
            captureBtn.addEventListener("click", freezeAndRecognize);
        </script>
    </body>
</html>
