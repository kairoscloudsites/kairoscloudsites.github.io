<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://kairoscloud.github.io/main/globalFirebase.js?v3"></script>
<script>
    (async () => {
        let locationID;
        let locationAccessKey;

        while (!window.GlobalLocationAccessKey) {
            // console.log("waiting for firebase");
            await new Promise((resolve) => setTimeout(resolve, 100));
            locationID = window.GlobalLocationID; // set by globalFirebase
            locationAccessKey = window.GlobalLocationAccessKey; // set by globalFirebase
        }
        let campaignList = [];
        const html = (strings, ...values) =>
            strings.reduce((acc, str, i) => acc + str + (values[i] ?? ""), "");
        let app = html`<!doctype html>
            <html lang="en">
                <head>
                    <meta charset="UTF-8" />
                    <meta
                        name="viewport"
                        content="width=device-width, initial-scale=1.0"
                    />
                    <title>Send to School (Mockup)</title>
                    <link
                        rel="icon"
                        href="https://kairoscloud.github.io/main/Assets/favicon.png"
                        type="image/x-icon"
                    />
                    <style>
                        :root {
                            --font-family:
                                -apple-system, BlinkMacSystemFont, "Segoe UI",
                                Roboto, Helvetica, Arial, sans-serif;
                            --background-color: #ffffff;
                            --text-primary: #1c1c1e;
                            --text-secondary: #6c757d;
                            --border-color: #ced4da;
                            --input-bg: #f0f2f5;
                            --button-bg: #4479ce;
                            --button-text: #ffffff;
                            --border-radius: 12px;
                        }

                        body {
                            font-family: var(--font-family);
                            background-color: var(--background-color);
                            color: var(--text-primary);
                            margin: 0;
                            /* CHANGE: Removed horizontal padding to make layout full-width. */
                            padding: 2rem 0;
                            display: flex;
                            justify-content: center;
                            box-sizing: border-box;
                        }

                        .container {
                            display: flex;
                            gap: 2rem;
                            width: 100%;
                            /* CHANGE: Removed max-width to let the container hug the screen edges. */
                        }

                        /* --- Main Content (Left Column) --- */
                        .main-content {
                            flex: 2 1 65%;
                            display: flex;
                            flex-direction: column;
                            min-width: 0;
                            /* CHANGE: Added padding here to keep content off the screen edge. */
                            padding-left: 2rem;
                        }

                        .main-content h1 {
                            font-size: 2rem;
                            font-weight: 700;
                            margin-top: 0;
                            margin-bottom: 2rem;
                        }

                        .form-and-previews {
                            display: flex;
                            gap: 2rem;
                            /* Ensures both columns stretch to the same height for alignment. */
                            align-items: stretch;
                        }

                        .send-form {
                            flex: 1 1 55%;
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                            min-width: 0;
                        }

                        /*
                          REASON: This is the key change for the vertical alignment request.
                          It selects the form group before "Additional Text" and applies a margin.
                          'margin-bottom: auto' pushes all subsequent items to the bottom of the
                          flex container, aligning the "Additional Text" box with the "Text Preview"
                          box in the adjacent column.
                        */
                        .send-form .form-group:nth-of-type(5) {
                            margin-bottom: auto;
                        }

                        .form-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .form-group label {
                            font-weight: 600;
                            font-size: 0.9rem;
                        }

                        .form-input,
                        .form-textarea {
                            width: 100%;
                            padding: 0.8rem 1rem;
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius);
                            font-size: 1rem;
                            font-family: var(--font-family);
                            box-sizing: border-box;
                        }

                        .form-input::placeholder,
                        .form-textarea::placeholder {
                            color: var(--text-secondary);
                        }

                        .select-wrapper {
                            position: relative;
                        }

                        .form-select {
                            appearance: none;
                            -webkit-appearance: none;
                            -moz-appearance: none;
                            width: 100%;
                            padding: 0.8rem 1rem;
                            border: 1px solid var(--input-bg);
                            background-color: var(--input-bg);
                            border-radius: var(--border-radius);
                            font-size: 1rem;
                            color: var(--text-secondary);
                            font-family: var(--font-family);
                            cursor: pointer;
                        }

                        .select-wrapper::after {
                            content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%236c757d" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
                            position: absolute;
                            right: 1rem;
                            top: 50%;
                            transform: translateY(-50%);
                            pointer-events: none;
                        }

                        .form-textarea {
                            height: 120px;
                            resize: vertical;
                            resize: none;
                        }

                        .form-actions {
                            display: flex;
                            gap: 1rem;
                            align-items: flex-end;
                            padding-top: 1rem;
                        }

                        .send-button {
                            background-color: var(--button-bg);
                            color: var(--button-text);
                            font-weight: 600;
                            border: none;
                            padding: 0.8rem 2.5rem;
                            border-radius: var(--border-radius);
                            font-size: 1rem;
                            cursor: pointer;
                            margin-left: auto;
                        }

                        /* --- Preview Panes --- */
                        .previews {
                            flex: 1 1 45%;
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                            min-width: 0;
                        }

                        .preview-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .preview-group label {
                            font-weight: 600;
                            font-size: 0.9rem;
                        }

                        #email-preview-box {
                            background-color: var(--input-bg);
                            border-radius: var(--border-radius);
                            height: 316px;
                        }

                        .text-preview-box {
                            background-color: var(--background-color);
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius);
                            height: 116px;
                        }

                        /* --- Sidebar (Right Column) --- */
                        .sidebar {
                            flex: 1 1 35%;
                            min-width: 280px;
                            padding-left: 2rem;
                            border-left: 1px solid #e5e5e5;
                            max-height: 95vh;
                            overflow-y: auto;
                            /* CHANGE: Added padding here to keep content off the screen edge. */
                            padding-right: 2rem;
                        }

                        .sidebar-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 2rem;
                        }

                        .sidebar-header h2 {
                            font-size: 2rem;
                            font-weight: 700;
                            margin: 0;
                            display: inline-block;
                        }

                        .sidebar-header .count {
                            font-size: 2rem;
                            font-weight: 400;
                            color: var(--text-secondary);
                            margin-left: 0.75rem;
                        }

                        .scheduled-list {
                            display: flex;
                            flex-direction: column;
                            gap: 1rem;
                        }

                        .scheduled-item {
                            background-color: var(--background-color);
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius);
                            padding: 1rem;
                        }

                        .scheduled-item .subject {
                            font-weight: 600;
                            margin-bottom: 0.25rem;
                        }

                        .scheduled-item .details {
                            font-size: 0.9rem;
                            color: var(--text-secondary);
                        }

                        /*
                          --- MEDIA QUERIES FOR RESPONSIVE DESIGN ---
                          The following rules adjust the layout for tablet and mobile screen sizes.
                        */

                        /* Breakpoint 1: Tablets and smaller desktops (<= 1024px) */
                        @media (max-width: 1024px) {
                            .container {
                                flex-direction: column;
                                gap: 3rem;
                            }

                            /* Adjust padding for stacked layout to provide consistent spacing. */
                            .main-content,
                            .sidebar {
                                padding-left: 1.5rem;
                                padding-right: 1.5rem;
                            }

                            .sidebar {
                                border-left: none;
                                border-top: 1px solid #e5e5e5;
                                padding-top: 2rem;
                                max-height: none;
                                overflow-y: visible;
                            }
                        }

                        /* Breakpoint 2: Mobile phones (<= 768px) */
                        @media (max-width: 768px) {
                            body {
                                padding: 1.5rem 0;
                            }

                            /* Further reduce padding for small screens. */
                            .main-content,
                            .sidebar {
                                padding-left: 1rem;
                                padding-right: 1rem;
                            }

                            .main-content h1,
                            .sidebar-header h2,
                            .sidebar-header .count {
                                font-size: 1.75rem;
                            }

                            .form-and-previews {
                                flex-direction: column;
                                gap: 2.5rem;
                            }

                            /* Reset the alignment hack, as columns are now stacked. */
                            .send-form .form-group:nth-of-type(5) {
                                margin-bottom: 0;
                            }

                            .form-actions {
                                flex-direction: column;
                                align-items: stretch;
                            }

                            .send-button {
                                margin-left: 0;
                                padding: 1rem;
                            }

                            .form-actions .form-input {
                                width: 100% !important;
                            }
                        }

                        #adminContactContainer {
                            height: 20px;
                            background-color: #f0f2f5;
                            margin-top: -15px;
                            margin-bottom: 10px;
                            padding: 3px;
                            padding-left: 16px;
                            border-radius: 6px;
                            color: #6c757d;
                        }

                        #arw {
                            margin-right: 6px;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <main class="main-content">
                            <h1>Send</h1>
                            <div class="form-and-previews">
                                <form
                                    class="send-form"
                                    action="#"
                                    method="post"
                                >
                                    <div class="form-group">
                                        <label for="admin-email"
                                            >Administrator Email</label
                                        >
                                        <input
                                            type="email"
                                            id="admin-email"
                                            name="admin_email"
                                            class="form-input"
                                            placeholder="administrator@school.com"
                                            oninput="handleAdminInput(this.value)"
                                        />
                                    </div>
                                    <div id="adminContactContainer"></div>

                                    <div class="form-group">
                                        <label for="campaign"
                                            >Select Campaign</label
                                        >
                                        <div class="select-wrapper">
                                            <select
                                                id="campaign"
                                                name="campaign"
                                                class="form-select"
                                            >
                                                ${await getCampaignList()}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="email-template"
                                            >Select Email Template</label
                                        >
                                        <div class="select-wrapper">
                                            <select
                                                id="email-template"
                                                name="email_template"
                                                class="form-select"
                                            >
                                                <option>
                                                    Example Template
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- <div class="form-group">
                                        <label for="text-template"
                                            >Select Text Template</label
                                        >
                                        <div class="select-wrapper">
                                            <select
                                                id="text-template"
                                                name="text_template"
                                                class="form-select"
                                            >
                                                <option>Example Template</option>
                                            </select>
                                        </div>
                                    </div> -->

                                    <div class="form-group">
                                        <label for="additional-text"
                                            >Additional Text</label
                                        >
                                        <textarea
                                            id="additional-text"
                                            name="additional_text"
                                            class="form-textarea"
                                        >
Hello Jane, please send this to all Senior parents.</textarea
                                        >
                                    </div>

                                    <div class="form-actions">
                                        <div class="form-group">
                                            <label for="send-on">Send on</label>
                                            <input
                                                type="datetime-local"
                                                id="send-on"
                                                name="send_on"
                                                class="form-input"
                                                placeholder="MM/DD/YY  1:00 PM"
                                                style="width: 230px"
                                            />
                                        </div>
                                        <button
                                            type="submit"
                                            class="send-button"
                                        >
                                            Send
                                        </button>
                                    </div>
                                </form>

                                <div class="previews">
                                    <div class="preview-group">
                                        <label>Email Template Preview</label>
                                        <div id="email-preview-box"></div>
                                    </div>
                                    <div class="preview-group">
                                        <label>Text Template Preview</label>
                                        <textarea
                                            id="additional-text"
                                            name="additional_text"
                                            class="form-textarea"
                                            style="height: 117px"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </main>

                        <aside class="sidebar">
                            <div class="sidebar-header">
                                <h2>Scheduled</h2>
                                <span class="count">13</span>
                            </div>
                            <div class="scheduled-list">
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello2!</div>
                                    <div class="details">
                                        help@website.site, May 29, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Email subject</div>
                                    <div class="details">
                                        address@site.com, October 9, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello2!</div>
                                    <div class="details">
                                        help@website.site, May 29, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Email subject</div>
                                    <div class="details">
                                        address@site.com, October 9, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                            </div>
                        </aside>
                    </div>
                </body>
            </html>`;

        document.write(app);

        // begin js

        const adminContactContainer = document.getElementById(
            "adminContactContainer",
        );
        const campaignSelect = document.getElementById("campaign");
        const emailTemplateSelect = document.getElementById("email-template");
        const emailPreviewBox = document.getElementById("email-preview-box");

        let adminTimeout;
        let emailTemplates = [];

        window.handleAdminInput = function handleAdminInput(value) {
            clearTimeout(adminTimeout);
            adminContactContainer.innerHTML = "Searching...";
            if (value.length < 3) {
                adminContactContainer.innerHTML =
                    "Please enter an email address.";
                return;
            }
            adminTimeout = setTimeout(async () => {
                const contact = await getAdminContact(value);
                if (contact) {
                    adminContactContainer.innerHTML = `${contact.firstName} ${
                        contact.lastName
                    }`;
                } else {
                    adminContactContainer.innerHTML = "No contact found";
                }
            }, 500);
        };

        window.getAdminContact = async function getAdminContact(query) {
            const url = "https://services.leadconnectorhq.com/contacts/search";
            const options = {
                method: "POST",
                headers: {
                    Authorization: "Bearer " + locationAccessKey,
                    Version: "2021-07-28",
                    "Content-Type": "application/json",
                    Accept: "application/json",
                },
                body: `{
            "pageLimit" : 1,
            "locationId" : "${locationID}",
            "query" : "${query.replace(/"/g, '\\"')}"
            }`,
            };

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                console.log(data);
                return data.contacts[0];
            } catch (error) {
                console.error(error);
            }
        };

        async function getCampaignList() {
            let returnVar = `<option value="" disabled selected>Select a campaign</option>`;
            const campaignsRef = firestore
                .collection("campaigns_restructured")
                .doc(locationID)
                .collection("campaigns");

            const snapshot = await campaignsRef.get();
            snapshot.forEach((doc) => {
                campaignList.push({
                    id: doc.id,
                    data: doc.data(),
                });
                returnVar += `<option value="${doc.id}">${doc.data().name}</option>`;
            });
            console.log("Campaign list loaded:", campaignList);
            return returnVar;
        }

        /**
         * Replaces custom field placeholders in an HTML string with data from a campaign object.
         * @param {string} html - The HTML template content.
         * @param {object} campaignData - The data object for the selected campaign.
         * @returns {string} The HTML with placeholders filled in.
         */
        function mergeCustomFields(html, campaignData) {
            if (!html || !campaignData) return html || "";
            // Regex to find all placeholders like {{schoolName}} or {{ mascot }}
            return html.replace(/{{(.*?)}}/g, (match, key) => {
                const trimmedKey = key.trim();
                // If the key exists in the campaign data, replace it. Otherwise, keep the original placeholder.
                if (campaignData.hasOwnProperty(trimmedKey)) {
                    return campaignData[trimmedKey];
                }
                return match;
            });
        }

        /**
         * Fetches template content, merges campaign data, and updates the preview iframe.
         */
        /**
         * Fetches template content, merges campaign data, and updates the preview iframe.
         */
        /**
         * Fetches template content, merges campaign data, and updates the preview iframe.
         * This function is rewritten to:
         * 1. Fetch the template HTML from the `previewUrl` provided in the template list API response.
         * 2. Fetch location-wide custom values from the GHL API.
         * 3. Merge both campaign-specific fields (from Firestore) and GHL custom values into the template.
         */
        /**
         * Fetches template content, merges campaign data and GHL custom values,
         * and updates the preview iframe.
         */
        async function updatePreview() {
            const campaignId = campaignSelect.value;
            const templateId = emailTemplateSelect.value;

            // Initial state message
            emailPreviewBox.innerHTML =
                '<p style="text-align:center; color: var(--text-secondary); padding: 2rem;">Select a campaign and template to see a preview.</p>';

            if (!campaignId || !templateId) {
                return;
            }

            emailPreviewBox.innerHTML =
                '<p style="text-align:center; color: var(--text-secondary); padding: 2rem;">Loading preview...</p>';

            try {
                // 1. Get campaign data from the pre-fetched list
                const selectedCampaign = campaignList.find(
                    (c) => c.id === campaignId,
                );
                if (!selectedCampaign) {
                    throw new Error("Selected campaign data not found.");
                }
                const campaignData = selectedCampaign.data;

                // 2. Find the selected template object to get its previewUrl
                const selectedTemplate = emailTemplates.find(
                    (t) => t.id === templateId,
                );
                if (!selectedTemplate || !selectedTemplate.previewUrl) {
                    throw new Error(
                        "Selected template's preview URL not found.",
                    );
                }

                // 3. Fetch GHL Custom Values and the template HTML in parallel
                const [ghlValuesResponse, templateHtmlResponse] =
                    await Promise.all([
                        fetch(
                            `https://services.leadconnectorhq.com/locations/${locationID}/customValues`,
                            {
                                method: "GET",
                                headers: {
                                    Authorization:
                                        "Bearer " + locationAccessKey,
                                    Version: "2021-07-28",
                                    Accept: "application/json",
                                },
                            },
                        ),
                        // Fetch the template content from its public preview URL
                        fetch(selectedTemplate.previewUrl),
                    ]);

                if (!ghlValuesResponse.ok) {
                    throw new Error(
                        `Failed to fetch custom values: ${ghlValuesResponse.statusText}`,
                    );
                }
                if (!templateHtmlResponse.ok) {
                    throw new Error(
                        `Failed to fetch template HTML: ${templateHtmlResponse.statusText}`,
                    );
                }

                const ghlValuesData = await ghlValuesResponse.json();
                const ghlCustomValues = ghlValuesData.customValues || [];
                let templateHtml = await templateHtmlResponse.text();

                if (typeof templateHtml !== "string") {
                    throw new Error(
                        "Template body could not be loaded as text.",
                    );
                }

                // 4. Merge GHL custom values (e.g., {{ custom_values.some_key }})
                ghlCustomValues.forEach((cv) => {
                    // The fieldKey from the API is the full string, e.g., "{{ custom_values.custom_field }}"
                    // We create a global RegExp from it to replace all occurrences.
                    const keyRegex = new RegExp(
                        cv.fieldKey.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"),
                        "g",
                    );
                    templateHtml = templateHtml.replace(keyRegex, cv.value);
                });

                // 5. Merge campaign-specific custom fields (e.g., {{schoolName}})
                const finalHtml = mergeCustomFields(templateHtml, campaignData);

                // 6. Display in an iframe for style isolation
                emailPreviewBox.innerHTML = ""; // Clear loading message
                const iframe = document.createElement("iframe");
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.style.border = "none";
                iframe.style.borderRadius = "var(--border-radius)";
                emailPreviewBox.appendChild(iframe);
                iframe.contentWindow.document.open();
                iframe.contentWindow.document.write(finalHtml);
                iframe.contentWindow.document.close();
            } catch (error) {
                console.error("Error updating preview:", error);
                emailPreviewBox.innerHTML = `<p style="padding: 1rem; color: red;">Could not load preview. ${error.message}</p>`;
            }
        }
        /**
         * Fetches the list of email templates and populates the dropdown.
         */
        async function initializeEmailTemplates() {
            try {
                const url = `https://services.leadconnectorhq.com/emails/builder?locationId=${locationID}&limit=100`; // Fetch up to 100 templates
                const options = {
                    method: "GET",
                    headers: {
                        Authorization: "Bearer " + locationAccessKey,
                        Version: "2021-07-28",
                        Accept: "application/json",
                    },
                };
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(
                        `API request failed: ${response.statusText}`,
                    );
                }
                const data = await response.json();

                // API might return an object with a key 'templates' or just an array
                const templates = data.builders || data;
                console.log(data);

                if (!Array.isArray(templates)) {
                    throw new Error(
                        "Unexpected response format for email templates.",
                    );
                }
                emailTemplates = templates; // Cache templates if needed

                let optionsHtml = `<option value="" disabled selected>Select an email template</option>`;
                templates.forEach((template) => {
                    if (template.previewUrl) {
                        optionsHtml += `<option value="${template.id}">${template.name}</option>`;
                    }
                });
                emailTemplateSelect.innerHTML = optionsHtml;
            } catch (error) {
                console.error("Failed to fetch email templates:", error);
                emailTemplateSelect.innerHTML = `<option value="" disabled selected>Error loading templates</option>`;
            }
        }

        // Add event listeners for the dropdowns
        campaignSelect.addEventListener("change", updatePreview);
        emailTemplateSelect.addEventListener("change", updatePreview);

        // Initial call to populate templates
        initializeEmailTemplates();

        // Set the initial state for the preview box
        updatePreview();
    })();
</script>
