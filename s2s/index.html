<!doctype html>
<html lang="en">
    <!-- START OF FILE index.html -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://kairoscloud.github.io/main/globalFirebase.js?v3"></script>

    <script>
        (async () => {
            let locationID;
            let locationAccessKey;

            while (!window.GlobalLocationAccessKey) {
                await new Promise((resolve) => setTimeout(resolve, 100));
                locationID = window.GlobalLocationID; // set by globalFirebase
                locationAccessKey = window.GlobalLocationAccessKey; // set by globalFirebase
            }
            let campaignList = [];
            const html = (strings, ...values) =>
                strings.reduce(
                    (acc, str, i) => acc + str + (values[i] ?? ""),
                    "",
                );
            let app = html`<!doctype html>
                <html lang="en">
                    <head>
                        <meta charset="UTF-8" />
                        <meta
                            name="viewport"
                            content="width=device-width, initial-scale=1.0"
                        />
                        <title>Send to School (Mockup)</title>
                        <link
                            rel="icon"
                            href="https://kairoscloud.github.io/main/Assets/favicon.png"
                            type="image/x-icon"
                        />
                        <style>
                            :root {
                                --font-family:
                                    -apple-system, BlinkMacSystemFont,
                                    "Segoe UI", Roboto, Helvetica, Arial,
                                    sans-serif;
                                --background-color: #ffffff;
                                --text-primary: #1c1c1e;
                                --text-secondary: #6c757d;
                                --border-color: #ced4da;
                                --input-bg: #f0f2f5;
                                --button-bg: #4479ce;
                                --button-text: #ffffff;
                                --border-radius: 12px;
                            }

                            body {
                                font-family: var(--font-family);
                                background-color: var(--background-color);
                                color: var(--text-primary);
                                margin: 0;
                                /* CHANGE: Removed horizontal padding to make layout full-width. */
                                padding: 1.3rem 0;
                                display: flex;
                                justify-content: center;
                                box-sizing: border-box;
                                overflow-y: scroll;
                            }

                            .container {
                                display: flex;
                                gap: 2rem;
                                width: 100%;
                                /* CHANGE: Removed max-width to let the container hug the screen edges. */
                            }

                            /* --- Main Content (Left Column) --- */
                            .main-content {
                                flex: 2 1 65%;
                                display: flex;
                                flex-direction: column;
                                min-width: 0;
                                /* CHANGE: Added padding here to keep content off the screen edge. */
                                padding-left: 2rem;
                            }

                            .main-content h1 {
                                font-size: 2rem;
                                font-weight: 700;
                                margin-top: 0;
                            }

                            .form-and-previews {
                                display: flex;
                                gap: 2rem;
                                /* Ensures both columns stretch to the same height for alignment. */
                                align-items: stretch;
                            }

                            .send-form {
                                flex: 1 1 55%;
                                display: flex;
                                flex-direction: column;
                                gap: 1.5rem;
                                min-width: 0;
                            }

                            /*
                            REASON: This is the key change for the vertical alignment request.
                            It selects the form group before "Additional Text" and applies a margin.
                            'margin-bottom: auto' pushes all subsequent items to the bottom of the
                            flex container, aligning the "Additional Text" box with the "Notes"
                            box in the adjacent column.
                            */
                            .send-form .form-group {
                                margin-bottom: -4px;
                            }

                            .form-group {
                                display: flex;
                                flex-direction: column;
                                gap: 0.5rem;
                            }

                            .form-group label {
                                font-weight: 600;
                                font-size: 0.9rem;
                            }

                            .form-input,
                            .form-textarea {
                                width: 100%;
                                padding: 0.8rem 1rem;
                                border: 1px solid var(--border-color);
                                border-radius: var(--border-radius);
                                font-size: 1rem;
                                font-family: var(--font-family);
                                box-sizing: border-box;
                            }

                            .form-input::placeholder,
                            .form-textarea::placeholder {
                                color: var(--text-secondary);
                            }

                            .select-wrapper {
                                position: relative;
                            }

                            .form-select {
                                appearance: none;
                                -webkit-appearance: none;
                                -moz-appearance: none;
                                width: 100%;
                                padding: 0.8rem 1rem;
                                border: 1px solid var(--input-bg);
                                background-color: var(--input-bg);
                                border-radius: var(--border-radius);
                                font-size: 1rem;
                                color: var(--text-secondary);
                                font-family: var(--font-family);
                                cursor: pointer;
                            }

                            .select-wrapper::after {
                                content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%236c757d" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
                                position: absolute;
                                right: 1rem;
                                top: 50%;
                                transform: translateY(-50%);
                                pointer-events: none;
                            }

                            .form-textarea {
                                height: 120px;
                                resize: vertical;
                                resize: none;
                            }

                            .form-actions {
                                display: flex;
                                gap: 1rem;
                                align-items: flex-end;
                                /*padding-top: 1rem;*/
                            }

                            .send-button {
                                background-color: var(--button-bg);
                                color: var(--button-text);
                                font-weight: 600;
                                border: none;
                                padding: 0.8rem 2.5rem;
                                border-radius: var(--border-radius);
                                font-size: 1rem;
                                cursor: pointer;
                                margin-left: auto;
                                display: flex; /* NEW: For aligning spinner */
                                align-items: center; /* NEW: For aligning spinner */
                                justify-content: center; /* NEW: For aligning spinner */
                                gap: 0.5rem; /* NEW: For spacing spinner */
                            }

                            .send-button:disabled {
                                background-color: #a0b8da;
                                cursor: not-allowed;
                            }

                            /* --- Preview Panes --- */
                            .previews {
                                flex: 1 1 45%;
                                display: flex;
                                flex-direction: column;
                                gap: 1.5rem;
                                min-width: 0;
                            }

                            .preview-group {
                                display: flex;
                                flex-direction: column;
                                gap: 0.5rem;
                            }

                            .preview-group label {
                                font-weight: 600;
                                font-size: 0.9rem;
                            }

                            #email-preview-box {
                                background-color: var(--input-bg);
                                border-radius: var(--border-radius);
                                height: 327px;
                                overflow-y: auto;
                                padding: 1rem;
                                box-sizing: border-box;
                            }

                            #email-preview-iframe {
                                width: 100%;
                                height: 100%;
                                border: none;
                                background-color: #ffffff;
                            }

                            /* --- Sidebar (Right Column) --- */
                            .sidebar {
                                flex: 1 1 35%;
                                min-width: 260px;
                                max-width: 300px;
                                padding-left: 2rem;
                                border-left: 1px solid #e5e5e5;
                                max-height: 95vh;
                                overflow-y: auto;
                                padding-right: 2rem;
                            }

                            .sidebar-header {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 2rem;
                            }

                            .sidebar-header h2 {
                                font-size: 2rem;
                                font-weight: 700;
                                margin: 0;
                                display: inline-block;
                            }

                            .sidebar-header .count {
                                font-size: 2rem;
                                font-weight: 400;
                                color: var(--text-secondary);
                                margin-left: 0.75rem;
                            }

                            /* NEW: Styles for relocated error messages */
                            .sidebar-error-item {
                                background-color: #f8d7da; /* Light red */
                                border: 1px solid #f5c6cb; /* Darker red border */
                                color: #721c24; /* Dark red text */
                                border-radius: var(
                                    --border-radius
                                ); /* Match scheduled-item */
                                padding: 1rem; /* Match scheduled-item */
                                margin-bottom: 1rem; /* Space below it */
                                font-size: 0.9rem;
                                line-height: 1.4;
                                opacity: 1;
                                transition: opacity 0.5s ease-out;
                            }

                            .sidebar-error-item.fade-out {
                                opacity: 0;
                            }

                            .scheduled-list {
                                display: flex;
                                flex-direction: column;
                                gap: 1rem;
                            }

                            .scheduled-item {
                                background-color: var(--background-color);
                                border: 1px solid var(--border-color);
                                border-radius: var(--border-radius);
                                padding: 1rem;
                            }

                            .scheduled-item .subject {
                                font-weight: 600;
                                margin-bottom: 0.25rem;
                            }

                            .scheduled-item .details {
                                font-size: 0.9rem;
                                color: var(--text-secondary);
                            }

                            /* --- MEDIA QUERIES FOR RESPONSIVE DESIGN --- */
                            @media (max-width: 1024px) {
                                .container {
                                    flex-direction: column;
                                    gap: 3rem;
                                }
                                .main-content,
                                .sidebar {
                                    padding-left: 1.5rem;
                                    padding-right: 1.5rem;
                                }
                                .sidebar {
                                    border-left: none;
                                    border-top: 1px solid #e5e5e5;
                                    padding-top: 2rem;
                                    max-height: none;
                                    overflow-y: visible;
                                }
                            }

                            @media (max-width: 768px) {
                                body {
                                    padding: 1.5rem 0;
                                }
                                .main-content,
                                .sidebar {
                                    padding-left: 1rem;
                                    padding-right: 1rem;
                                }
                                .main-content h1,
                                .sidebar-header h2,
                                .sidebar-header .count {
                                    font-size: 1.75rem;
                                }
                                .form-and-previews {
                                    flex-direction: column;
                                    gap: 2.5rem;
                                }
                                .send-form .form-group:nth-of-type(4) {
                                    margin-bottom: 0;
                                }
                                .form-actions {
                                    flex-direction: column;
                                    align-items: stretch;
                                }
                                .send-button {
                                    margin-left: 0;
                                    padding: 1rem;
                                }
                                .form-actions .form-input {
                                    width: 100% !important;
                                }
                            }

                            #adminContactContainer {
                                height: 20px;
                                background-color: #f0f2f5;
                                margin-top: -15px;
                                padding: 3px;
                                padding-left: 16px;
                                border-radius: 6px;
                                color: #6c757d;
                                display: flex;
                                align-items: center;
                            }

                            .no-scheduled-emails {
                                color: #6c757d;
                                font-size: 0.875rem;
                                margin-top: -1.25rem;
                                margin-bottom: 1.5rem;
                            }

                            #arw {
                                margin-right: 6px;
                            }
                            .spinner {
                                border: 2px solid #f3f3f3;
                                border-top: 2px solid var(--button-bg);
                                border-radius: 50%;
                                width: 14px;
                                height: 14px;
                                animation: spin 1s linear infinite;
                                display: inline-block;
                                margin-right: 8px;
                            }

                            .button-spinner {
                                border-top-color: var(--button-text);
                                margin-right: 0;
                            }

                            @keyframes spin {
                                0% {
                                    transform: rotate(0deg);
                                }
                                100% {
                                    transform: rotate(360deg);
                                }
                            }
                            .checkmark {
                                display: inline-block;
                                margin-right: 8px;
                                color: #28a745;
                                font-weight: bold;
                                font-size: 16px;
                                line-height: 1;
                            }
                        </style>
                    </head>
                    <body style="padding: 0">
                        <div class="container">
                            <main class="main-content">
                                <div class="form-and-previews">
                                    <form
                                        class="send-form"
                                        action="#"
                                        method="post"
                                        novalidate
                                    >
                                        <div class="form-group">
                                            <label for="admin-email"
                                                >Administrator Email</label
                                            >
                                            <input
                                                type="email"
                                                id="admin-email"
                                                name="admin_email"
                                                class="form-input"
                                                placeholder="administrator@school.com"
                                                required
                                            />
                                        </div>
                                        <div id="adminContactContainer">
                                            Contact name will appear here
                                        </div>

                                        <div class="form-group">
                                            <label for="cc-email">CC to</label>
                                            <input
                                                type="email"
                                                id="cc-email"
                                                name="cc_email"
                                                class="form-input"
                                                placeholder="cc@example.com"
                                            />
                                        </div>

                                        <div class="form-group">
                                            <label for="campaign"
                                                >Select Campaign</label
                                            >
                                            <div class="select-wrapper">
                                                <select
                                                    id="campaign"
                                                    name="campaign"
                                                    class="form-select"
                                                    required
                                                >
                                                    ${await getCampaignList()}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- START MODIFICATION: Replaced email template dropdown with text template dropdown -->
                                        <div class="form-group">
                                            <label for="text-template"
                                                >Select Template</label
                                            >
                                            <div class="select-wrapper">
                                                <select
                                                    id="text-template"
                                                    name="text_template"
                                                    class="form-select"
                                                    required
                                                >
                                                    <!-- Options populated by JS -->
                                                </select>
                                            </div>
                                        </div>
                                        <!-- END MODIFICATION -->

                                        <div class="form-group">
                                            <textarea
                                                style="height: 145px"
                                                id="additional-text"
                                                name="additional_text"
                                                class="form-textarea"
                                                placeholder=""
                                            ></textarea>
                                        </div>

                                        <div class="form-actions">
                                            <div class="form-group">
                                                <span style="display:" flex>
                                                    <label for="send-on"
                                                        >Send on</label
                                                    >
                                                    <span
                                                        style="color:grey; font-size: 0.9rem;"
                                                    >
                                                        (Optional)
                                                    </span>
                                                </span>
                                                <input
                                                    type="datetime-local"
                                                    id="send-on"
                                                    name="send_on"
                                                    class="form-input"
                                                    placeholder="MM/DD/YY  1:00 PM"
                                                    style="width: 230px"
                                                />
                                            </div>
                                            <button
                                                type="submit"
                                                class="send-button"
                                                id="send-button"
                                            >
                                                Send
                                            </button>
                                        </div>
                                        <div
                                            id="form-submission-status"
                                            style="text-align: right; margin-top: 0.5rem;"
                                        ></div>
                                    </form>

                                    <div class="previews">
                                        <div class="preview-group">
                                            <label
                                                >Email Template Preview</label
                                            >
                                            <div id="email-preview-box">
                                                <!-- Iframe will be injected here -->
                                            </div>
                                        </div>
                                        <!-- START MODIFICATION: Removed pre-written email template selector -->
                                        <!-- END MODIFICATION -->
                                        <div class="preview-group">
                                            <label for="notes-text"
                                                >Notes</label
                                            >
                                            <textarea
                                                id="notes-text"
                                                name="notes_text"
                                                class="form-textarea"
                                                placeholder="Internal notes for the administrator..."
                                                style="height: 146px"
                                            >
Hello,
Please forward this message to your student families. You can either copy the text below or open a pre-written email by clicking on the button. Let me know if you have any questions.
Thank you!</textarea
                                            >
                                        </div>
                                    </div>
                                </div>
                            </main>

                            <aside class="sidebar">
                                <div class="sidebar-header">
                                    <h2>Scheduled</h2>
                                    <span class="count">0</span>
                                </div>
                                <!-- MODIFICATION: New container for validation errors -->
                                <div id="sidebar-error-container"></div>
                                <div class="scheduled-list">
                                    <!-- Dynamically populated by script -->
                                </div>
                            </aside>
                        </div>
                    </body>
                </html>`;

            document.write(app);

            // --- GLOBAL STATE & CACHE ---
            const sendForm = document.querySelector(".send-form");
            const sendButton = document.getElementById("send-button");
            const adminEmailInput = document.getElementById("admin-email");
            const ccEmailInput = document.getElementById("cc-email");
            // get "senderParam" from url param "sender"
            const senderParam = new URLSearchParams(window.location.search).get(
                "sender",
            );
            console.log("Sender Param: ", senderParam);
            const formSubmissionStatus = document.getElementById(
                "form-submission-status",
            );
            const adminContactContainer = document.getElementById(
                "adminContactContainer",
            );
            const campaignSelect = document.getElementById("campaign");
            // START MODIFICATION: Replace email template selector with text template selector
            const textTemplateSelect = document.getElementById("text-template");
            // END MODIFICATION
            const sendOnInput = document.getElementById("send-on");
            const emailPreviewBox =
                document.getElementById("email-preview-box");
            const scheduledListContainer =
                document.querySelector(".scheduled-list");
            const scheduledCountElement = document.querySelector(
                ".sidebar-header .count",
            );
            const notesTextInput = document.getElementById("notes-text");
            const additionalTextInput =
                document.getElementById("additional-text");
            // START MODIFICATION: Remove pre-written template selector
            // END MODIFICATION

            let adminSearchTimeout;
            let previewUpdateTimeout;
            let emailTemplates = [];
            // START MODIFICATION: Add state for text templates and the fixed email template
            let textTemplates = [];
            let fixedEmailTemplate = null; // This will hold the "Send to School" template object
            // END MODIFICATION
            let locationCustomFields = [];
            let locationCustomValues = [];
            let selectedAdminContact = null;
            let lastRenderedHtml = "";
            let scheduledEmails = []; // MODIFICATION: This is now populated by Firestore.

            // --- API HELPERS ---
            async function apiFetch(url, options = {}) {
                const defaultOptions = {
                    headers: {
                        Authorization: "Bearer " + locationAccessKey,
                        Version: "2021-07-28",
                        "Content-Type": "application/json",
                        Accept: "application/json",
                    },
                };
                const mergedOptions = { ...defaultOptions, ...options };
                mergedOptions.headers = {
                    ...defaultOptions.headers,
                    ...options.headers,
                };

                const response = await fetch(url, mergedOptions);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(
                        `API Error (${response.status}): ${errorText}`,
                    );
                }
                return response.json();
            }

            // --- NEW: FIRESTORE INTEGRATION ---
            /**
             * Fetches upcoming scheduled emails from Firestore for the current location.
             */
            async function fetchScheduledEmailsFromFirestore() {
                try {
                    const emailsRef = firestore
                        .collection("scheduled_emails")
                        .doc(locationID)
                        .collection("emails");

                    // Query for emails scheduled in the future
                    const snapshot = await emailsRef
                        .where("sendOn", ">", new Date())
                        .get();

                    const fetchedEmails = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        fetchedEmails.push({
                            subject: data.subject,
                            email: data.to,
                            date: data.sendOn.toDate(), // Convert Firestore Timestamp to JS Date
                        });
                    });

                    scheduledEmails = fetchedEmails; // Replace in-memory array
                    console.log(
                        "Successfully fetched scheduled emails from Firestore.",
                    );
                } catch (error) {
                    console.error(
                        "Error fetching scheduled emails from Firestore:",
                        error,
                    );
                    // Graceful degradation: The app will continue with an empty list.
                }
            }

            /**
             * Saves a new scheduled email to Firestore under the current location.
             * @param {object} emailData - The email data to save.
             * @param {string} emailData.subject - The email subject/campaign name.
             * @param {string} emailData.to - The recipient's email address.
             * @param {string} emailData.cc - The CC recipient's email address.
             * @param {string} emailData.body - The full HTML body of the email.
             * @param {Date} emailData.date - The JavaScript Date object for when to send.
             */
            async function saveScheduledEmailToFirestore(emailData) {
                try {
                    const emailsRef = firestore
                        .collection("scheduled_emails")
                        .doc(locationID)
                        .collection("emails");

                    const payload = {
                        sendOn: firebase.firestore.Timestamp.fromDate(
                            emailData.date,
                        ), // Convert JS Date to Firestore Timestamp
                        subject: emailData.subject,
                        body: emailData.body,
                        to: emailData.to,
                        cc: emailData.cc || "", // Ensure cc is at least an empty string
                    };

                    await emailsRef.add(payload);
                    console.log(
                        "Successfully saved scheduled email to Firestore.",
                    );
                } catch (error) {
                    console.error(
                        "Error saving scheduled email to Firestore:",
                        error,
                    );
                    // Re-throw the error to be caught by the form submission handler
                    throw new Error("Failed to save schedule to the database.");
                }
            }

            // --- UTILITY FUNCTIONS ---
            const debounce = (func, delay) => {
                return (...args) => {
                    clearTimeout(previewUpdateTimeout);
                    previewUpdateTimeout = setTimeout(
                        () => func.apply(this, args),
                        delay,
                    );
                };
            };
            const debouncedUpdatePreview = debounce(updatePreview, 300);

            // --- UI & STATE MANAGEMENT ---

            function renderScheduledList() {
                scheduledListContainer.innerHTML = "";
                scheduledCountElement.textContent = scheduledEmails.length;

                if (scheduledEmails.length === 0) {
                    scheduledListContainer.innerHTML =
                        '<span class="no-scheduled-emails">No scheduled emails yet</span>';
                } else {
                    const sortedEmails = [...scheduledEmails].sort(
                        (a, b) => b.date - a.date,
                    );

                    sortedEmails.forEach((item) => {
                        const formattedDate = item.date
                            .toLocaleString("en-US", {
                                year: "numeric",
                                month: "short",
                                day: "numeric",
                                hour: "numeric",
                                minute: "2-digit",
                                hour12: true,
                            })
                            .replace(/,(\s\d{1,2}:\d{2}\s[AP]M)/, "$1");

                        const itemHtml = `
                        <div class="scheduled-item">
                            <div class="subject">${item.subject}</div>
                            <div class="details">
                                ${item.email}, ${formattedDate}
                            </div>
                        </div>
                    `;
                        scheduledListContainer.insertAdjacentHTML(
                            "beforeend",
                            itemHtml,
                        );
                    });
                }
            }

            adminEmailInput.addEventListener("input", (e) => {
                clearTimeout(adminSearchTimeout);
                selectedAdminContact = null;

                const value = e.target.value;
                if (value.length < 3) {
                    adminContactContainer.innerHTML =
                        "Contact name will appear here";
                    debouncedUpdatePreview();
                    return;
                }
                adminContactContainer.innerHTML =
                    '<span class="spinner"></span>Searching...';
                adminSearchTimeout = setTimeout(async () => {
                    try {
                        const contact = await getAdminContact(value);
                        if (contact) {
                            selectedAdminContact = contact;
                            adminContactContainer.innerHTML = `<span class="checkmark">âœ“</span> ${contact.firstName} ${contact.lastName} (${contact.email})`;
                        } else {
                            adminContactContainer.innerHTML =
                                "No contact found.";
                        }
                    } catch (error) {
                        console.error("Error finding admin contact:", error);
                        adminContactContainer.innerHTML =
                            "Contact name will appear here";
                    }
                    debouncedUpdatePreview();
                }, 500);
            });

            // --- DATA FETCHING & INITIALIZATION ---
            async function getAdminContact(query) {
                const searchUrl =
                    "https://services.leadconnectorhq.com/contacts/search";
                const searchOptions = {
                    method: "POST",
                    body: JSON.stringify({
                        pageLimit: 1,
                        locationId: locationID,
                        query: query,
                    }),
                };

                const searchData = await apiFetch(searchUrl, searchOptions);
                const contactStub = searchData.contacts[0];

                if (!contactStub) {
                    return null;
                }

                const fullContactUrl = `https://services.leadconnectorhq.com/contacts/${contactStub.id}`;
                const fullContactData = await apiFetch(fullContactUrl);
                return fullContactData.contact;
            }

            async function getCampaignList() {
                let returnVar = `<option value="" disabled selected>Select a campaign</option>`;
                // sort them alphabetically by field 'name'

                let campaignsRef = firestore
                    .collection("campaigns_restructured")
                    .doc(locationID)
                    .collection("campaigns")
                    .orderBy("name", "asc");
                const snapshot = await campaignsRef.get();
                snapshot.forEach((doc) => {
                    const campaignData = doc.data();
                    if (!campaignData.schoolName) {
                        campaignData.schoolName = campaignData.name;
                    }

                    campaignList.push({
                        id: doc.id,
                        data: campaignData,
                    });
                    returnVar += `<option value="${doc.id}">${
                        doc.data().name
                    }</option>`;
                });

                console.log("Campaign list loaded:", campaignList);
                return returnVar;
            }

            // START MODIFICATION: Find and set the fixed "Send to School" email template
            async function initializeEmailTemplates() {
                try {
                    const url = `https://services.leadconnectorhq.com/emails/builder?locationId=${locationID}&limit=100`;
                    const data = await apiFetch(url, { method: "GET" });
                    const templates = data.builders || data;

                    if (!Array.isArray(templates)) {
                        throw new Error(
                            "Unexpected format for email templates.",
                        );
                    }
                    emailTemplates = templates;
                    fixedEmailTemplate = emailTemplates.find(
                        (t) => t.name === "Send to School",
                    );

                    if (!fixedEmailTemplate) {
                        console.error(
                            'FATAL: The "Send to School" email template was not found.',
                        );
                        // Optionally, disable the form or show a permanent error message
                    } else {
                        console.log(
                            'Successfully found "Send to School" template.',
                            fixedEmailTemplate,
                        );
                    }
                } catch (error) {
                    console.error("Failed to fetch email templates:", error);
                }
            }
            // END MODIFICATION

            // START MODIFICATION: New function to fetch and populate SMS/Text templates
            async function initializeTextTemplates() {
                try {
                    const url = `https://services.leadconnectorhq.com/locations/${locationID}/templates?type=sms`;
                    const data = await apiFetch(url);
                    textTemplates = data.templates || [];

                    let optionsHtml = `<option value="" disabled selected>Select a text template</option>`;
                    textTemplates.forEach((template) => {
                        optionsHtml += `<option value="${template.id}">${template.name}</option>`;
                    });
                    textTemplateSelect.innerHTML = optionsHtml;
                } catch (error) {
                    console.error("Failed to fetch text templates:", error);
                    textTemplateSelect.innerHTML = `<option value="" disabled selected>Error loading templates</option>`;
                }
            }
            // END MODIFICATION

            async function fetchCustomFieldDefinitions() {
                try {
                    const url = `https://services.leadconnectorhq.com/locations/${locationID}/customFields`;
                    const data = await apiFetch(url, { method: "GET" });
                    locationCustomFields = data.customFields || [];
                    console.log(
                        "Custom field definitions loaded:",
                        locationCustomFields,
                    );
                } catch (error) {
                    console.error("Failed to fetch custom fields:", error);
                }
            }

            async function fetchCustomValues() {
                try {
                    const url = `https://services.leadconnectorhq.com/locations/${locationID}/customValues`;
                    const data = await apiFetch(url, { method: "GET" });
                    locationCustomValues = data.customValues || [];
                    console.log("Custom values loaded:", locationCustomValues);

                    // Pre-populate CC field
                    const jostensOfficeEmail = locationCustomValues.find(
                        (cv) =>
                            cv.fieldKey ===
                            "{{ custom_values.jostens_office_email }}",
                    );
                    if (jostensOfficeEmail && jostensOfficeEmail.value) {
                        // apparently drew doesn't want this :(
                        // ccEmailInput.value = jostensOfficeEmail.value;
                    }
                } catch (error) {
                    console.error("Failed to fetch custom values:", error);
                }
            }

            // --- CORE PREVIEW LOGIC (NOW WITH IFRAME) ---
            async function updatePreview() {
                const campaignId = campaignSelect.value;
                // START MODIFICATION: Use fixed template and check text template selection
                const textTemplateId = textTemplateSelect.value;
                // END MODIFICATION

                const renderInIframe = (content, style = "") => {
                    emailPreviewBox.innerHTML = "";
                    const iframe = document.createElement("iframe");
                    iframe.id = "email-preview-iframe";
                    iframe.setAttribute("sandbox", "allow-same-origin");
                    emailPreviewBox.appendChild(iframe);
                    iframe.srcdoc = content;
                    // lastRenderedHtml is now managed by the caller to distinguish between preview and sendable HTML
                };

                // START MODIFICATION: Update condition for showing preview
                if (
                    !selectedAdminContact ||
                    !campaignId ||
                    !fixedEmailTemplate ||
                    !textTemplateId
                ) {
                    const placeholder =
                        '<body style="background-color: #f0f2f5;"><p style="padding: 1rem; text-align:center; color: #6c757d; font-family: Arial, sans-serif;">Please select an administrator, campaign, and text template to see a preview.</p></body>';
                    renderInIframe(placeholder);
                    lastRenderedHtml = ""; // Clear sendable HTML state
                    return;
                }
                // END MODIFICATION

                renderInIframe(
                    '<body style="background-color: #f0f2f5;"><p style="padding: 1rem; text-align:center; color: #6c757d; font-family: Arial, sans-serif;">Loading...</p></body>',
                );
                lastRenderedHtml = ""; // Clear sendable HTML state

                try {
                    const selectedCampaign = campaignList.find(
                        (c) => c.id === campaignId,
                    ).data;
                    // START MODIFICATION: Use fixedEmailTemplate directly
                    const selectedTemplate = fixedEmailTemplate;
                    // END MODIFICATION

                    // --- START FIX 1: MAILTO LINK GENERATION ---
                    // REASON: Generate the mailto link dynamically based on current form values.
                    // This ensures the link is always up-to-date with the latest content.
                    const campaignName =
                        campaignSelect.options[campaignSelect.selectedIndex]
                            .text;
                    const textTemplateName =
                        textTemplateSelect.options[
                            textTemplateSelect.selectedIndex
                        ].text;
                    const finalSubject = `${campaignName} - ${textTemplateName}`;
                    const mailtoBody = additionalTextInput.value;

                    const encodedSubject = encodeURIComponent(finalSubject);
                    // Use `replace(/\n/g, "\r\n")` to ensure line breaks are preserved correctly across email clients.
                    const encodedBody = encodeURIComponent(
                        mailtoBody.replace(/\n/g, "\r\n"),
                    );
                    const mailtoLink = `mailto:?body=${encodedBody}`;
                    // --- END FIX 1 ---

                    const templateHtmlResponse = await fetch(
                        selectedTemplate.previewUrl,
                    ).then((res) => res.text());
                    let finalHtml = templateHtmlResponse;

                    // START MODIFICATION: Remove all pre-written template logic
                    // END MODIFICATION

                    const replaceRaw = (text, placeholder, value) => {
                        const regex = new RegExp(
                            placeholder.replace(
                                /[-\/\\^$*+?.()|[\]{}]/g,
                                "\\$&",
                            ),
                            "g",
                        );
                        return text.replace(regex, value ?? "");
                    };
                    const replace = (text, key, value) =>
                        replaceRaw(text, `{{contact.${key}}}`, value);

                    // START MODIFICATION: Remove processing for pre-written template and mailto link generation
                    // END MODIFICATION

                    // --- Process the MAIN template ---

                    // --- START FIX 2: SPECIAL FIELDS & LINE BREAKS ---
                    // REASON: Replace special placeholders with form content. Use .replace(/\n/g, "<br>")
                    // to preserve line breaks from textareas in the final HTML email.
                    finalHtml = replace(
                        finalHtml,
                        "send_to_school_notes",
                        notesTextInput.value.replace(/\n/g, "<br>"),
                    );
                    finalHtml = replace(
                        finalHtml,
                        "send_to_school_message",
                        additionalTextInput.value.replace(/\n/g, "<br>"),
                    );
                    // This uses the mailtoLink generated in FIX 1.
                    finalHtml = replaceRaw(
                        finalHtml,
                        "{{contact.send_to_school_email_link}}",
                        mailtoLink,
                    );
                    // --- END FIX 2 ---

                    // --- START FIX 3: CAMPAIGN FIELD MAPPING ---
                    // REASON: Corrected the mapping to match the required placeholder-to-property assignments.
                    // This ensures data from the campaign object is placed in the correct template fields.
                    Object.entries(selectedCampaign).forEach(([key, value]) => {
                        const mapping = {
                            jostensWebsiteLink: "jostens_website_link",
                            landingPage1: "landing_page_1",
                            landingPage2: "landing_page_2",
                            mascot: "mascot",
                            name: "campaign_name",
                            orderDueDate: "order_due_date",
                            schoolLocation: "school_location",
                            schoolLogo: "school_logo_link",
                            schoolName: "school_name", // Correctly mapped from campaign.schoolName
                        };
                        if (mapping[key]) {
                            // Apply formatDate specifically to orderDueDate
                            const processedValue =
                                key === "orderDueDate" && value
                                    ? formatDate(value)
                                    : value;
                            finalHtml = replace(
                                finalHtml,
                                mapping[key],
                                processedValue,
                            );
                        }
                    });
                    // --- END FIX 3 ---

                    // 3. Standard Contact Fields (and the new mailto link)
                    finalHtml = replace(
                        finalHtml,
                        "first_name",
                        selectedAdminContact.firstName,
                    );
                    finalHtml = replace(
                        finalHtml,
                        "last_name",
                        selectedAdminContact.lastName,
                    );
                    finalHtml = replace(
                        finalHtml,
                        "name",
                        selectedAdminContact.name,
                    );
                    finalHtml = replace(
                        finalHtml,
                        "email",
                        selectedAdminContact.email,
                    );
                    // START MODIFICATION: The placeholder mailto link replacement is now removed, as it's handled by FIX 1 & 2.
                    // END MODIFICATION

                    // 4. Custom Contact Fields
                    if (
                        Array.isArray(selectedAdminContact.customField) &&
                        locationCustomFields.length > 0
                    ) {
                        const customFieldKeyMap = locationCustomFields.reduce(
                            (acc, field) => {
                                acc[field.id] = field.fieldKey;
                                return acc;
                            },
                            {},
                        );

                        selectedAdminContact.customField.forEach(
                            (contactField) => {
                                const fieldKey =
                                    customFieldKeyMap[contactField.id];
                                if (fieldKey && contactField.value) {
                                    finalHtml = replaceRaw(
                                        finalHtml,
                                        `{{${fieldKey}}}`,
                                        contactField.value,
                                    );
                                }
                            },
                        );
                    }

                    // --- START FIX 4: CUSTOM VALUE REPLACEMENT ---
                    // REASON: Replaced the simple string search with a regular expression. This robustly handles
                    // placeholders with or without whitespace, e.g., `{{custom_values.key}}` and `{{ custom_values.key }}`.
                    if (locationCustomValues.length > 0) {
                        locationCustomValues.forEach((cv) => {
                            if (cv.fieldKey && cv.value) {
                                // Get the key name from inside the braces, e.g., "custom_values.jostens_office_email"
                                const keyWithoutBraces = cv.fieldKey
                                    .replace(/{{|}}/g, "")
                                    .trim();
                                // Create a regex to find this key with optional whitespace
                                const regex = new RegExp(
                                    `\\{\\{\\s*${keyWithoutBraces}\\s*\\}\\}`,
                                    "g",
                                );
                                finalHtml = finalHtml.replace(regex, cv.value);
                            }
                        });
                    }
                    // --- END FIX 4 ---

                    // 6. Cleanup remaining placeholders
                    finalHtml = finalHtml.replace(/{{(.*?)}}/g, "");

                    // The finalHtml is what we want to SEND. Store it.
                    lastRenderedHtml = finalHtml;

                    // For the PREVIEW, modify the mailto link to open in the parent frame.
                    const previewHtml = finalHtml.replace(
                        `href="${mailtoLink}"`,
                        `href="${mailtoLink}" target="_parent"`,
                    );

                    renderInIframe(previewHtml);
                } catch (error) {
                    console.error("Error updating preview:", error);
                    const errorHtml = `<p style="padding: 1rem; color: red;">Could not load preview. ${error.message}</p>`;
                    renderInIframe(errorHtml);
                    lastRenderedHtml = ""; // Clear sendable HTML state on error
                }
            }

            // --- FORM VALIDATION & SUBMISSION ---

            function validateForm() {
                const errorContainer = document.getElementById(
                    "sidebar-error-container",
                );
                errorContainer.innerHTML = "";

                const errors = [];
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                if (!selectedAdminContact) {
                    errors.push("A valid Administrator contact is required.");
                }
                if (!campaignSelect.value) {
                    errors.push("A Campaign must be selected.");
                }
                // START MODIFICATION: Update validation rules
                if (!textTemplateSelect.value) {
                    errors.push("A Text Template must be selected.");
                }
                // "Send On" date is now optional, so its validation is removed.
                // END MODIFICATION

                // MODIFICATION: Validate multiple CC email addresses
                if (ccEmailInput.value) {
                    const ccEmails = ccEmailInput.value
                        .split(",")
                        .map((email) => email.trim())
                        .filter((email) => email);
                    for (const email of ccEmails) {
                        if (!emailRegex.test(email)) {
                            errors.push(`Invalid CC email address: ${email}`);
                        }
                    }
                }

                if (errors.length > 0) {
                    const errorDiv = document.createElement("div");
                    errorDiv.className = "sidebar-error-item";
                    errorDiv.innerHTML = errors.join("<br>");
                    errorContainer.appendChild(errorDiv);

                    setTimeout(() => {
                        errorDiv.classList.add("fade-out");
                        setTimeout(() => {
                            if (errorDiv.parentNode) {
                                errorDiv.parentNode.removeChild(errorDiv);
                            }
                        }, 500);
                    }, 5000);
                }

                return errors.length === 0;
            }

            async function handleFormSubmit(event) {
                event.preventDefault();
                formSubmissionStatus.textContent = "";

                if (!validateForm()) {
                    return;
                }

                sendButton.disabled = true;
                sendButton.innerHTML =
                    '<span class="spinner button-spinner"></span>Sending...';

                try {
                    const campaignName =
                        campaignSelect.options[campaignSelect.selectedIndex]
                            .text;
                    // START MODIFICATION: Get text template name for subject
                    const textTemplateName =
                        textTemplateSelect.options[
                            textTemplateSelect.selectedIndex
                        ].text;
                    const finalSubject = `${campaignName} - ${textTemplateName}`;
                    // END MODIFICATION

                    const finalEmailBody = lastRenderedHtml;
                    // START MODIFICATION: If send date is empty, send immediately
                    const sendOnValue = sendOnInput.value;
                    const date = sendOnValue
                        ? new Date(sendOnValue)
                        : new Date(); // Use current time if field is empty
                    // END MODIFICATION

                    // MODIFICATION: Parse multiple CC emails
                    let ccEmailsArray = [];
                    if (ccEmailInput.value) {
                        ccEmailsArray = ccEmailInput.value
                            .split(",")
                            .map((email) => email.trim())
                            .filter((email) => email);
                    }

                    const payload = {
                        type: "Email",
                        contactId: selectedAdminContact.id,
                        emailFrom: senderParam,
                        emailTo: selectedAdminContact.email,
                        subject: finalSubject, // Use new subject format
                        html: finalEmailBody,
                        scheduledTimestamp: Math.floor(date.getTime() / 1000),
                    };

                    // MODIFICATION: Assign the array of CC emails to payload.emailCc
                    if (ccEmailsArray.length > 0) {
                        payload.emailCc = ccEmailsArray;
                    }

                    // MODIFICATION: Call the Firestore save function *before* updating UI
                    await saveScheduledEmailToFirestore({
                        subject: finalSubject, // Use new subject format
                        to: selectedAdminContact.email,
                        cc: ccEmailInput.value, // Keep this as the raw string for Firestore
                        body: finalEmailBody,
                        date: date,
                    });

                    await apiFetch(
                        "https://services.leadconnectorhq.com/conversations/messages",
                        {
                            method: "POST",
                            headers: { Version: "2021-04-15" },
                            body: JSON.stringify(payload),
                        },
                    );

                    sendButton.textContent = "Sent";
                    formSubmissionStatus.innerHTML =
                        '<span style="color: #28a745;">Message scheduled successfully!</span>';

                    // MODIFICATION: Update local state and re-render the list
                    const newScheduledItem = {
                        subject: finalSubject, // Use new subject format
                        email: selectedAdminContact.email,
                        date: date,
                    };
                    scheduledEmails.push(newScheduledItem);
                    renderScheduledList();

                    setTimeout(() => {
                        sendButton.disabled = false;
                        sendButton.textContent = "Send";
                        formSubmissionStatus.textContent = "";
                    }, 3000);
                } catch (error) {
                    console.error("API or Database Error:", error);
                    formSubmissionStatus.innerHTML = `<span style="color: #dc3545;">Failed to schedule message: ${error.message}</span>`;
                    sendButton.disabled = false;
                    sendButton.innerHTML = "Send";
                }
            }

            // --- INITIALIZATION & EVENT LISTENERS ---
            async function initializeApp() {
                // MODIFICATION: Fetch from Firestore when the app loads.
                await Promise.all([
                    fetchScheduledEmailsFromFirestore(),
                    initializeEmailTemplates(),
                    initializeTextTemplates(), // New call
                    fetchCustomFieldDefinitions(),
                    fetchCustomValues(),
                ]);
                renderScheduledList(); // Now renders with data from Firestore.
                updatePreview();
            }

            campaignSelect.addEventListener("change", debouncedUpdatePreview);
            // START MODIFICATION: Remove old listeners, add new one for text templates
            textTemplateSelect.addEventListener("change", () => {
                const templateId = textTemplateSelect.value;
                if (!templateId) {
                    additionalTextInput.value = "";
                    debouncedUpdatePreview();
                    return;
                }

                const selectedTemplate = textTemplates.find(
                    (t) => t.id === templateId,
                );
                let body = selectedTemplate.template.body;
                const campaignId = campaignSelect.value;
                const selectedCampaign = campaignList.find(
                    (c) => c.id === campaignId,
                )?.data;

                // --- START FIX 5: CUSTOM VALUES IN TEXT TEMPLATES ---
                // REASON: This adds the same robust custom value replacement to the text templates, ensuring
                // consistency between the text template body and the final email preview.
                if (locationCustomValues.length > 0) {
                    locationCustomValues.forEach((cv) => {
                        if (cv.fieldKey && cv.value) {
                            const keyWithoutBraces = cv.fieldKey
                                .replace(/{{|}}/g, "")
                                .trim();
                            const regex = new RegExp(
                                `\\{\\{\\s*${keyWithoutBraces}\\s*\\}\\}`,
                                "g",
                            );
                            body = body.replace(regex, cv.value);
                        }
                    });
                }
                // --- END FIX 5 ---

                // Apply replacements if possible
                if (selectedCampaign && selectedAdminContact) {
                    const replaceRaw = (text, placeholder, value) =>
                        text.replace(
                            new RegExp(
                                placeholder.replace(
                                    /[-\/\\^$*+?.()|[\]{}]/g,
                                    "\\$&",
                                ),
                                "g",
                            ),
                            value || "",
                        );
                    const replace = (text, key, value) =>
                        replaceRaw(text, `{{contact.${key}}}`, value);

                    // --- START FIX 6: CAMPAIGN MAPPING IN TEXT TEMPLATES ---
                    // REASON: Corrected the mapping here as well to ensure text templates are populated
                    // with the right campaign data before being placed in the "Additional Text" box.
                    Object.entries(selectedCampaign).forEach(([key, value]) => {
                        const mapping = {
                            jostensWebsiteLink: "jostens_website_link",
                            landingPage1: "landing_page_1",
                            landingPage2: "landing_page_2",
                            mascot: "mascot",
                            name: "campaign_name",
                            orderDueDate: "order_due_date",
                            schoolLocation: "school_location",
                            schoolLogo: "school_logo_link",
                            schoolName: "school_name",
                        };
                        if (mapping[key]) {
                            // Apply formatDate specifically to orderDueDate
                            const processedValue =
                                key === "orderDueDate" && value
                                    ? formatDate(value)
                                    : value;
                            body = replace(body, mapping[key], processedValue);
                        }
                    });
                    // --- END FIX 6 ---
                    body = replace(
                        body,
                        "first_name",
                        selectedAdminContact.firstName,
                    );
                    body = replace(
                        body,
                        "last_name",
                        selectedAdminContact.lastName,
                    );
                    body = replace(body, "name", selectedAdminContact.name);
                    body = replace(body, "email", selectedAdminContact.email);

                    if (
                        Array.isArray(selectedAdminContact.customField) &&
                        locationCustomFields.length > 0
                    ) {
                        const customFieldKeyMap = locationCustomFields.reduce(
                            (acc, field) => {
                                acc[field.id] = field.fieldKey;
                                return acc;
                            },
                            {},
                        );
                        selectedAdminContact.customField.forEach(
                            (contactField) => {
                                const fieldKey =
                                    customFieldKeyMap[contactField.id];
                                if (fieldKey && contactField.value) {
                                    body = replaceRaw(
                                        body,
                                        `{{${fieldKey}}}`,
                                        contactField.value,
                                    );
                                }
                            },
                        );
                    }
                    if (locationCustomValues.length > 0) {
                        locationCustomValues.forEach((cv) => {
                            if (cv.fieldKey && cv.value) {
                                body = replaceRaw(body, cv.fieldKey, cv.value);
                            }
                        });
                    }
                }

                additionalTextInput.value = body.replace(/{{(.*?)}}/g, "");
                debouncedUpdatePreview();
            });
            // END MODIFICATION
            notesTextInput.addEventListener("input", debouncedUpdatePreview);
            additionalTextInput.addEventListener(
                "input",
                debouncedUpdatePreview,
            );
            sendForm.addEventListener("submit", handleFormSubmit);

            initializeApp();

            function formatDate(input) {
                console.log("Formatting date: " + input);
                const [year, month, day] = input.split("-").map(Number);
                const date = new Date(year, month - 1, day); // Month is 0-based
                return date.toLocaleDateString("en-US", {
                    weekday: "long",
                    month: "long",
                    day: "numeric",
                });
            }
        })();
    </script>
</html>
