<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://kairoscloud.github.io/main/globalFirebase.js?v3"></script>

<script>
    (async () => {
        let locationID;
        let locationAccessKey;

        while (!window.GlobalLocationAccessKey) {
            // console.log("waiting for firebase");
            await new Promise((resolve) => setTimeout(resolve, 100));
            locationID = window.GlobalLocationID; // set by globalFirebase
            locationAccessKey = window.GlobalLocationAccessKey; // set by globalFirebase
        }
        let campaignList = [];
        const html = (strings, ...values) =>
            strings.reduce((acc, str, i) => acc + str + (values[i] ?? ""), "");
        let app = html`<!doctype html>
            <html lang="en">
                <head>
                    <meta charset="UTF-8" />
                    <meta
                        name="viewport"
                        content="width=device-width, initial-scale=1.0"
                    />
                    <title>Send to School (Mockup)</title>
                    <link
                        rel="icon"
                        href="https://kairoscloud.github.io/main/Assets/favicon.png"
                        type="image/x-icon"
                    />
                    <style>
                        :root {
                            --font-family:
                                -apple-system, BlinkMacSystemFont, "Segoe UI",
                                Roboto, Helvetica, Arial, sans-serif;
                            --background-color: #ffffff;
                            --text-primary: #1c1c1e;
                            --text-secondary: #6c757d;
                            --border-color: #ced4da;
                            --input-bg: #f0f2f5;
                            --button-bg: #4479ce;
                            --button-text: #ffffff;
                            --border-radius: 12px;
                        }

                        body {
                            font-family: var(--font-family);
                            background-color: var(--background-color);
                            color: var(--text-primary);
                            margin: 0;
                            /* CHANGE: Removed horizontal padding to make layout full-width. */
                            padding: 2rem 0;
                            display: flex;
                            justify-content: center;
                            box-sizing: border-box;
                        }

                        .container {
                            display: flex;
                            gap: 2rem;
                            width: 100%;
                            /* CHANGE: Removed max-width to let the container hug the screen edges. */
                        }

                        /* --- Main Content (Left Column) --- */
                        .main-content {
                            flex: 2 1 65%;
                            display: flex;
                            flex-direction: column;
                            min-width: 0;
                            /* CHANGE: Added padding here to keep content off the screen edge. */
                            padding-left: 2rem;
                        }

                        .main-content h1 {
                            font-size: 2rem;
                            font-weight: 700;
                            margin-top: 0;
                            margin-bottom: 2rem;
                        }

                        .form-and-previews {
                            display: flex;
                            gap: 2rem;
                            /* Ensures both columns stretch to the same height for alignment. */
                            align-items: stretch;
                        }

                        .send-form {
                            flex: 1 1 55%;
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                            min-width: 0;
                        }

                        /*
REASON: This is the key change for the vertical alignment request.
It selects the form group before "Additional Text" and applies a margin.
'margin-bottom: auto' pushes all subsequent items to the bottom of the
flex container, aligning the "Additional Text" box with the "Text Preview"
box in the adjacent column.
*/
                        .send-form .form-group:nth-of-type(5) {
                            margin-bottom: auto;
                        }

                        .form-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .form-group label {
                            font-weight: 600;
                            font-size: 0.9rem;
                        }

                        .form-input,
                        .form-textarea {
                            width: 100%;
                            padding: 0.8rem 1rem;
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius);
                            font-size: 1rem;
                            font-family: var(--font-family);
                            box-sizing: border-box;
                        }

                        .form-input::placeholder,
                        .form-textarea::placeholder {
                            color: var(--text-secondary);
                        }

                        .select-wrapper {
                            position: relative;
                        }

                        .form-select {
                            appearance: none;
                            -webkit-appearance: none;
                            -moz-appearance: none;
                            width: 100%;
                            padding: 0.8rem 1rem;
                            border: 1px solid var(--input-bg);
                            background-color: var(--input-bg);
                            border-radius: var(--border-radius);
                            font-size: 1rem;
                            color: var(--text-secondary);
                            font-family: var(--font-family);
                            cursor: pointer;
                        }

                        .select-wrapper::after {
                            content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%236c757d" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
                            position: absolute;
                            right: 1rem;
                            top: 50%;
                            transform: translateY(-50%);
                            pointer-events: none;
                        }

                        .form-textarea {
                            height: 120px;
                            resize: vertical;
                            resize: none;
                        }

                        .form-actions {
                            display: flex;
                            gap: 1rem;
                            align-items: flex-end;
                            padding-top: 1rem;
                        }

                        .send-button {
                            background-color: var(--button-bg);
                            color: var(--button-text);
                            font-weight: 600;
                            border: none;
                            padding: 0.8rem 2.5rem;
                            border-radius: var(--border-radius);
                            font-size: 1rem;
                            cursor: pointer;
                            margin-left: auto;
                        }

                        /* --- Preview Panes --- */
                        .previews {
                            flex: 1 1 45%;
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                            min-width: 0;
                        }

                        .preview-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .preview-group label {
                            font-weight: 600;
                            font-size: 0.9rem;
                        }

                        #email-preview-box {
                            background-color: var(--input-bg);
                            border-radius: var(--border-radius);
                            height: 316px;
                            overflow-y: auto;
                            padding: 1rem;
                            box-sizing: border-box;
                        }

                        .text-preview-box {
                            background-color: var(--background-color);
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius);
                            height: 116px;
                        }

                        /* --- Sidebar (Right Column) --- */
                        .sidebar {
                            flex: 1 1 35%;
                            min-width: 280px;
                            padding-left: 2rem;
                            border-left: 1px solid #e5e5e5;
                            max-height: 95vh;
                            overflow-y: auto;
                            /* CHANGE: Added padding here to keep content off the screen edge. */
                            padding-right: 2rem;
                        }

                        .sidebar-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 2rem;
                        }

                        .sidebar-header h2 {
                            font-size: 2rem;
                            font-weight: 700;
                            margin: 0;
                            display: inline-block;
                        }

                        .sidebar-header .count {
                            font-size: 2rem;
                            font-weight: 400;
                            color: var(--text-secondary);
                            margin-left: 0.75rem;
                        }

                        .scheduled-list {
                            display: flex;
                            flex-direction: column;
                            gap: 1rem;
                        }

                        .scheduled-item {
                            background-color: var(--background-color);
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius);
                            padding: 1rem;
                        }

                        .scheduled-item .subject {
                            font-weight: 600;
                            margin-bottom: 0.25rem;
                        }

                        .scheduled-item .details {
                            font-size: 0.9rem;
                            color: var(--text-secondary);
                        }

                        /*
--- MEDIA QUERIES FOR RESPONSIVE DESIGN ---
The following rules adjust the layout for tablet and mobile screen sizes.
*/

                        /* Breakpoint 1: Tablets and smaller desktops (<= 1024px) */
                        @media (max-width: 1024px) {
                            .container {
                                flex-direction: column;
                                gap: 3rem;
                            }

                            /* Adjust padding for stacked layout to provide consistent spacing. */
                            .main-content,
                            .sidebar {
                                padding-left: 1.5rem;
                                padding-right: 1.5rem;
                            }

                            .sidebar {
                                border-left: none;
                                border-top: 1px solid #e5e5e5;
                                padding-top: 2rem;
                                max-height: none;
                                overflow-y: visible;
                            }
                        }

                        /* Breakpoint 2: Mobile phones (<= 768px) */
                        @media (max-width: 768px) {
                            body {
                                padding: 1.5rem 0;
                            }

                            /* Further reduce padding for small screens. */
                            .main-content,
                            .sidebar {
                                padding-left: 1rem;
                                padding-right: 1rem;
                            }

                            .main-content h1,
                            .sidebar-header h2,
                            .sidebar-header .count {
                                font-size: 1.75rem;
                            }

                            .form-and-previews {
                                flex-direction: column;
                                gap: 2.5rem;
                            }

                            /* Reset the alignment hack, as columns are now stacked. */
                            .send-form .form-group:nth-of-type(5) {
                                margin-bottom: 0;
                            }

                            .form-actions {
                                flex-direction: column;
                                align-items: stretch;
                            }

                            .send-button {
                                margin-left: 0;
                                padding: 1rem;
                            }

                            .form-actions .form-input {
                                width: 100% !important;
                            }
                        }

                        #adminContactContainer {
                            height: 20px;
                            background-color: #f0f2f5;
                            margin-top: -15px;
                            margin-bottom: 10px;
                            padding: 3px;
                            padding-left: 16px;
                            border-radius: 6px;
                            color: #6c757d;
                            display: flex;
                            align-items: center;
                        }

                        #arw {
                            margin-right: 6px;
                        }
                        /* Spinner */
                        .spinner {
                            border: 2px solid #f3f3f3;
                            border-top: 2px solid var(--button-bg);
                            border-radius: 50%;
                            width: 14px;
                            height: 14px;
                            animation: spin 1s linear infinite;
                            display: inline-block;
                            margin-right: 8px;
                        }
                        @keyframes spin {
                            0% {
                                transform: rotate(0deg);
                            }
                            100% {
                                transform: rotate(360deg);
                            }
                        }
                        /* Checkmark */
                        .checkmark {
                            display: inline-block;
                            margin-right: 8px;
                            color: #28a745; /* green */
                            font-weight: bold;
                            font-size: 16px;
                            line-height: 1;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <main class="main-content">
                            <h1>Send</h1>
                            <div class="form-and-previews">
                                <form
                                    class="send-form"
                                    action="#"
                                    method="post"
                                >
                                    <div class="form-group">
                                        <label for="admin-email"
                                            >Administrator Email</label
                                        >
                                        <input
                                            type="email"
                                            id="admin-email"
                                            name="admin_email"
                                            class="form-input"
                                            placeholder="administrator@school.com"
                                            oninput="handleAdminInput(this.value)"
                                        />
                                    </div>
                                    <div id="adminContactContainer"></div>

                                    <div class="form-group">
                                        <label for="campaign"
                                            >Select Campaign</label
                                        >
                                        <div class="select-wrapper">
                                            <select
                                                id="campaign"
                                                name="campaign"
                                                class="form-select"
                                            >
                                                ${await getCampaignList()}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="email-template"
                                            >Select Email Template</label
                                        >
                                        <div class="select-wrapper">
                                            <select
                                                id="email-template"
                                                name="email_template"
                                                class="form-select"
                                            >
                                                <option>
                                                    Example Template
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- <div class="form-group">
                                    <label for="text-template"
                                        >Select Text Template</label
                                    >
                                    <div class="select-wrapper">
                                        <select
                                            id="text-template"
                                            name="text_template"
                                            class="form-select"
                                        >
                                            <option>Example Template</option>
                                        </select>
                                    </div>
                                </div> -->

                                    <div class="form-group">
                                        <label for="additional-text"
                                            >Additional Text</label
                                        >
                                        <textarea
                                            id="additional-text"
                                            name="additional_text"
                                            class="form-textarea"
                                        >
Hello Jane, please send this to all Senior parents.</textarea
                                        >
                                    </div>

                                    <div class="form-actions">
                                        <div class="form-group">
                                            <label for="send-on">Send on</label>
                                            <input
                                                type="datetime-local"
                                                id="send-on"
                                                name="send_on"
                                                class="form-input"
                                                placeholder="MM/DD/YY  1:00 PM"
                                                style="width: 230px"
                                            />
                                        </div>
                                        <button
                                            type="submit"
                                            class="send-button"
                                        >
                                            Send
                                        </button>
                                    </div>
                                </form>

                                <div class="previews">
                                    <div class="preview-group">
                                        <label>Email Template Preview</label>
                                        <div id="email-preview-box"></div>
                                    </div>
                                    <div class="preview-group">
                                        <label>Text Template Preview</label>
                                        <textarea
                                            id="additional-text"
                                            name="additional_text"
                                            class="form-textarea"
                                            style="height: 117px"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </main>

                        <aside class="sidebar">
                            <div class="sidebar-header">
                                <h2>Scheduled</h2>
                                <span class="count">13</span>
                            </div>
                            <div class="scheduled-list">
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello2!</div>
                                    <div class="details">
                                        help@website.site, May 29, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Email subject</div>
                                    <div class="details">
                                        address@site.com, October 9, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello2!</div>
                                    <div class="details">
                                        help@website.site, May 29, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Email subject</div>
                                    <div class="details">
                                        address@site.com, October 9, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                                <div class="scheduled-item">
                                    <div class="subject">Hello!</div>
                                    <div class="details">
                                        test@example.com, March 10, 2024
                                    </div>
                                </div>
                            </div>
                        </aside>
                    </div>
                </body>
            </html>`;

        document.write(app);

        // --- GLOBAL STATE & CACHE ---
        const adminContactContainer = document.getElementById(
            "adminContactContainer",
        );
        const campaignSelect = document.getElementById("campaign");
        const emailTemplateSelect = document.getElementById("email-template");
        const emailPreviewBox = document.getElementById("email-preview-box");

        let adminSearchTimeout;
        let emailTemplates = [];
        let locationCustomFields = [];
        let selectedAdminContact = null;

        // --- API HELPERS ---
        async function apiFetch(url, options = {}) {
            const defaultOptions = {
                headers: {
                    Authorization: "Bearer " + locationAccessKey,
                    Version: "2021-07-28",
                    "Content-Type": "application/json",
                    Accept: "application/json",
                },
            };
            const mergedOptions = { ...defaultOptions, ...options };
            mergedOptions.headers = {
                ...defaultOptions.headers,
                ...options.headers,
            };

            const response = await fetch(url, mergedOptions);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error (${response.status}): ${errorText}`);
            }
            return response.json();
        }

        // --- UI & STATE MANAGEMENT ---
        window.handleAdminInput = function handleAdminInput(value) {
            clearTimeout(adminSearchTimeout);
            selectedAdminContact = null; // Reset on new input
            if (value.length < 3) {
                adminContactContainer.innerHTML =
                    "Please enter an email address.";
                updatePreview();
                return;
            }
            adminContactContainer.innerHTML =
                '<span class="spinner"></span>Searching...';
            adminSearchTimeout = setTimeout(async () => {
                try {
                    const contact = await getAdminContact(value);
                    if (contact) {
                        selectedAdminContact = contact;
                        adminContactContainer.innerHTML = `<span class="checkmark">✓</span> ${contact.firstName} ${contact.lastName}`;
                    } else {
                        adminContactContainer.innerHTML = "No contact found.";
                    }
                } catch (error) {
                    console.error("Error finding admin contact:", error);
                    adminContactContainer.innerHTML = "Error finding contact.";
                }
                updatePreview();
            }, 500);
        };

        // --- DATA FETCHING & INITIALIZATION ---
        window.getAdminContact = async function getAdminContact(query) {
            const searchUrl =
                "https://services.leadconnectorhq.com/contacts/search";
            const searchOptions = {
                method: "POST",
                body: JSON.stringify({
                    pageLimit: 1,
                    locationId: locationID,
                    query: query,
                }),
            };

            const searchData = await apiFetch(searchUrl, searchOptions);
            const contactStub = searchData.contacts[0];

            if (!contactStub) {
                return null;
            }

            // Fetch the full contact object to ensure custom fields are included
            const fullContactUrl = `https://services.leadconnectorhq.com/contacts/${contactStub.id}`;
            const fullContactData = await apiFetch(fullContactUrl);
            return fullContactData.contact; // The full object is nested
        };

        async function getCampaignList() {
            let returnVar = `<option value="" disabled selected>Select a campaign</option>`;
            const campaignsRef = firestore
                .collection("campaigns_restructured")
                .doc(locationID)
                .collection("campaigns");

            const snapshot = await campaignsRef.get();
            snapshot.forEach((doc) => {
                campaignList.push({
                    id: doc.id,
                    data: doc.data(),
                });
                returnVar += `<option value="${doc.id}">${doc.data().name}</option>`;
            });
            console.log("Campaign list loaded:", campaignList);
            return returnVar;
        }

        async function initializeEmailTemplates() {
            try {
                const url = `https://services.leadconnectorhq.com/emails/builder?locationId=${locationID}&limit=100`;
                const data = await apiFetch(url, { method: "GET" });
                const templates = data.builders || data;

                if (!Array.isArray(templates)) {
                    throw new Error("Unexpected format for email templates.");
                }
                emailTemplates = templates;

                let optionsHtml = `<option value="" disabled selected>Select an email template</option>`;
                templates.forEach((template) => {
                    if (template.previewUrl) {
                        optionsHtml += `<option value="${template.id}">${template.name}</option>`;
                    }
                });
                emailTemplateSelect.innerHTML = optionsHtml;
            } catch (error) {
                console.error("Failed to fetch email templates:", error);
                emailTemplateSelect.innerHTML = `<option value="" disabled selected>Error loading templates</option>`;
            }
        }

        async function fetchCustomFieldDefinitions() {
            try {
                const url = `https://services.leadconnectorhq.com/locations/${locationID}/customFields`;
                const data = await apiFetch(url, { method: "GET" });
                locationCustomFields = data.customFields || [];
                console.log(
                    "Custom field definitions loaded:",
                    locationCustomFields,
                );
            } catch (error) {
                console.error("Failed to fetch custom fields:", error);
            }
        }

        // --- CORE PREVIEW LOGIC ---
        async function updatePreview() {
            const campaignId = campaignSelect.value;
            const templateId = emailTemplateSelect.value;

            // 1. Check if all conditions are met
            if (!selectedAdminContact || !campaignId || !templateId) {
                emailPreviewBox.innerHTML =
                    '<p style="text-align:center; color: var(--text-secondary);">Please select an administrator, campaign, and template to see a preview.</p>';
                return;
            }

            emailPreviewBox.innerHTML =
                '<p style="text-align:center; color: var(--text-secondary);">Loading preview...</p>';

            try {
                // 2. Gather all required data
                const selectedCampaign = campaignList.find(
                    (c) => c.id === campaignId,
                ).data;
                const selectedTemplate = emailTemplates.find(
                    (t) => t.id === templateId,
                );

                const [ghlValuesResponse, templateHtmlResponse] =
                    await Promise.all([
                        apiFetch(
                            `https://services.leadconnectorhq.com/locations/${locationID}/customValues`,
                        ),
                        fetch(selectedTemplate.previewUrl).then((res) =>
                            res.text(),
                        ),
                    ]);

                const ghlCustomValues = ghlValuesResponse.customValues || [];
                let finalHtml = templateHtmlResponse;

                // 3. MERGE DATA (IN ORDER OF PRECEDENCE)

                // STEP 3.1: Merge GHL Custom Values (e.g., {{custom_values.some_key}})
                ghlCustomValues.forEach((cv) => {
                    const keyRegex = new RegExp(
                        cv.fieldKey.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"),
                        "g",
                    );
                    finalHtml = finalHtml.replace(keyRegex, cv.value || "");
                });

                // STEP 3.2: Merge Firestore Campaign Data (e.g., {{contact.school_name}})
                Object.keys(selectedCampaign).forEach((key) => {
                    let placeholderKey = key
                        .replace(/([A-Z])/g, "_$1")
                        .toLowerCase(); // camelCase to snake_case
                    if (key === "name") placeholderKey = "campaign_name"; // Exception
                    if (key === "mascot") placeholderKey = "school_mascot"; // Exception

                    const placeholder = `{{contact.${placeholderKey}}}`;
                    const regex = new RegExp(
                        placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"),
                        "g",
                    );
                    finalHtml = finalHtml.replace(
                        regex,
                        selectedCampaign[key] || "",
                    );
                });

                // STEP 3.3: Merge GHL Contact Data
                // Standard Fields
                const standardFieldMap = {
                    first_name: selectedAdminContact.firstName,
                    last_name: selectedAdminContact.lastName,
                    name: selectedAdminContact.name,
                    email: selectedAdminContact.email,
                    phone: selectedAdminContact.phone,
                    address1: selectedAdminContact.address1,
                    city: selectedAdminContact.city,
                    state: selectedAdminContact.state,
                    country: selectedAdminContact.country,
                    postal_code: selectedAdminContact.postalCode,
                    website: selectedAdminContact.website,
                    company_name: selectedAdminContact.companyName,
                    timezone: selectedAdminContact.timezone,
                };

                for (const [key, value] of Object.entries(standardFieldMap)) {
                    const placeholder = `{{contact.${key}}}`;
                    const regex = new RegExp(
                        placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"),
                        "g",
                    );
                    finalHtml = finalHtml.replace(regex, value || "");
                }

                // Custom Fields
                const contactCustomFieldValues = {};
                if (selectedAdminContact.customFields) {
                    selectedAdminContact.customFields.forEach((cf) => {
                        contactCustomFieldValues[cf.id] = cf.value;
                    });
                }
                locationCustomFields.forEach((definition) => {
                    const value = contactCustomFieldValues[definition.id];
                    if (value !== undefined) {
                        const placeholder = `{{${definition.fieldKey}}}`;
                        const regex = new RegExp(
                            placeholder.replace(
                                /[-\/\\^$*+?.()|[\]{}]/g,
                                "\\$&",
                            ),
                            "g",
                        );
                        finalHtml = finalHtml.replace(regex, value);
                    }
                });

                // STEP 3.4: Final Cleanup - Remove any unfilled placeholders
                finalHtml = finalHtml.replace(/{{(.*?)}}/g, "");

                // 4. Render the final HTML directly into the preview box
                emailPreviewBox.innerHTML = finalHtml;
            } catch (error) {
                console.error("Error updating preview:", error);
                emailPreviewBox.innerHTML = `<p style="padding: 1rem; color: red;">Could not load preview. ${error.message}</p>`;
            }
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        async function initializeApp() {
            await Promise.all([
                initializeEmailTemplates(),
                fetchCustomFieldDefinitions(),
            ]);
            updatePreview(); // Set initial state message
        }

        campaignSelect.addEventListener("change", updatePreview);
        emailTemplateSelect.addEventListener("change", updatePreview);

        initializeApp();
    })();
</script>
