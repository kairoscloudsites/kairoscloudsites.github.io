<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gemini API Playground</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            :root {
                --bg: #f5f5f5;
                --panel: #fff;
                --border: #e0e0e0;
                --text: #333;
                --text-muted: #888;
                --accent: #333;
                --input-bg: #fafafa;
                --hover: #f0f0f0;
                --danger: #dc2626;
                --danger-hover: #b91c1c;
            }

            html,
            body {
                height: 100%;
                overflow: hidden;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: var(--bg);
                color: var(--text);
                font-size: 12px;
            }

            .app {
                display: grid;
                grid-template-columns: 240px 1fr;
                height: 100vh;
                gap: 1px;
                background: var(--border);
            }

            .sidebar {
                background: var(--panel);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .sidebar-header {
                padding: 12px;
                font-weight: 600;
                font-size: 13px;
                border-bottom: 1px solid var(--border);
            }

            .sidebar-content {
                flex: 1;
                overflow-y: auto;
                padding: 8px;
            }

            .main {
                background: var(--panel);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* Custom Select */
            .select {
                position: relative;
                width: 100%;
            }

            .select select {
                width: 100%;
                padding: 6px 24px 6px 8px;
                border: 1px solid var(--border);
                border-radius: 4px;
                background: var(--input-bg);
                color: var(--text);
                font-size: 11px;
                font-family: "Monaco", "Menlo", monospace;
                cursor: pointer;
                appearance: none;
                -webkit-appearance: none;
            }

            .select::after {
                content: "â–¾";
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
                color: var(--text-muted);
                font-size: 10px;
            }

            /* Custom Input */
            .input {
                width: 100%;
                padding: 6px 8px;
                border: 1px solid var(--border);
                border-radius: 4px;
                background: var(--input-bg);
                color: var(--text);
                font-size: 11px;
                font-family: "Monaco", "Menlo", monospace;
            }

            .input:focus {
                outline: none;
                border-color: var(--accent);
            }

            /* Custom Checkbox */
            .checkbox {
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                font-size: 11px;
                padding: 4px 0;
            }

            .checkbox input {
                display: none;
            }

            .checkbox .box {
                width: 14px;
                height: 14px;
                border: 1px solid var(--border);
                border-radius: 3px;
                background: var(--input-bg);
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .checkbox input:checked + .box {
                background: var(--accent);
                border-color: var(--accent);
            }

            .checkbox input:checked + .box::after {
                content: "âœ“";
                color: #fff;
                font-size: 10px;
            }

            /* Collapsible Section */
            .section {
                border: 1px solid var(--border);
                border-radius: 4px;
                margin-bottom: 6px;
                overflow: hidden;
            }

            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 10px;
                background: var(--input-bg);
                cursor: pointer;
                font-size: 11px;
                font-weight: 500;
                user-select: none;
            }

            .section-header:hover {
                background: var(--hover);
            }

            .section-arrow {
                font-size: 8px;
                color: var(--text-muted);
                transition: transform 0.2s;
            }

            .section.open .section-arrow {
                transform: rotate(180deg);
            }

            .section-body {
                display: none;
                padding: 8px 10px;
                border-top: 1px solid var(--border);
            }

            .section.open .section-body {
                display: block;
            }

            .field {
                margin-bottom: 6px;
            }

            .field:last-child {
                margin-bottom: 0;
            }

            .field-label {
                font-size: 10px;
                color: var(--text-muted);
                margin-bottom: 3px;
                font-family: "Monaco", "Menlo", monospace;
            }

            .field-row {
                display: flex;
                gap: 6px;
            }

            .field-row > * {
                flex: 1;
            }

            /* Buttons */
            .btn {
                padding: 6px 12px;
                border: 1px solid var(--border);
                border-radius: 4px;
                background: var(--panel);
                color: var(--text);
                font-size: 11px;
                cursor: pointer;
                font-family: inherit;
            }

            .btn:hover {
                background: var(--hover);
            }

            .btn-primary {
                background: var(--accent);
                color: #fff;
                border-color: var(--accent);
            }

            .btn-primary:hover {
                background: #444;
            }

            .btn-primary:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-danger {
                background: var(--danger);
                color: #fff;
                border-color: var(--danger);
            }

            .btn-danger:hover {
                background: var(--danger-hover);
            }

            .btn-icon {
                width: 28px;
                height: 28px;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                border-radius: 4px;
            }

            .btn-sm {
                padding: 3px 8px;
                font-size: 10px;
            }

            /* Stats */
            .stats {
                display: flex;
                gap: 12px;
                padding: 8px 10px;
                background: var(--input-bg);
                border-radius: 4px;
                margin-top: 6px;
            }

            .stat {
                text-align: center;
                flex: 1;
            }

            .stat-value {
                font-size: 12px;
                font-weight: 600;
                font-family: "Monaco", "Menlo", monospace;
            }

            .stat-label {
                font-size: 9px;
                color: var(--text-muted);
                text-transform: uppercase;
            }

            /* Chat Area */
            .chat-header {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                border-bottom: 1px solid var(--border);
            }

            .chat-header .btn {
                margin-left: auto;
            }

            /* Attachment Bar (New) */
            .attachment-bar {
                padding: 8px 12px 4px 12px;
                background: var(--input-bg);
                border-bottom: 1px solid var(--border);
            }

            .attachment-controls {
                display: flex;
                gap: 8px;
                margin-bottom: 6px;
            }

            .system-prompt {
                padding: 8px 12px;
                border-bottom: 1px solid var(--border);
                background: var(--input-bg);
            }

            .system-prompt textarea {
                width: 100%;
                border: none;
                background: transparent;
                resize: none;
                font-size: 11px;
                font-family: "Monaco", "Menlo", monospace;
                color: var(--text);
                outline: none;
            }

            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 12px;
            }

            .message {
                margin-bottom: 12px;
                display: flex;
                flex-direction: column;
            }

            .message.user {
                align-items: flex-end;
            }

            .message-role {
                font-size: 9px;
                color: var(--text-muted);
                margin-bottom: 3px;
                text-transform: uppercase;
            }

            .message-content {
                max-width: 85%;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 12px;
                line-height: 1.4;
                font-family: "Monaco", "Menlo", monospace;
                white-space: pre-wrap;
                word-break: break-word;
            }

            .message.user .message-content {
                background: var(--accent);
                color: #fff;
                border-bottom-right-radius: 2px;
            }

            .message.model .message-content {
                background: var(--input-bg);
                border: 1px solid var(--border);
                border-bottom-left-radius: 2px;
            }

            .message-thinking {
                background: #fffbeb;
                border-left: 2px solid #f59e0b;
                padding: 6px 10px;
                margin-bottom: 6px;
                font-size: 10px;
                color: #92400e;
                border-radius: 4px;
            }

            .message-code {
                background: #f0fdf4;
                border-left: 2px solid #22c55e;
                padding: 6px 10px;
                margin-top: 6px;
                font-size: 10px;
                color: #166534;
                border-radius: 4px;
            }

            .message-error {
                background: #fef2f2;
                border: 1px solid #fecaca;
                color: #dc2626;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 11px;
            }

            /* JSON Editor */
            .json-editor {
                flex: 1;
                display: none;
                padding: 12px;
                overflow: auto;
            }

            .json-editor.active {
                display: block;
            }

            .json-editor textarea {
                width: 100%;
                height: 100%;
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 8px;
                font-family: "Monaco", "Menlo", monospace;
                font-size: 11px;
                resize: none;
                background: var(--input-bg);
            }

            .chat-messages.hidden {
                display: none;
            }

            /* Input Area */
            .chat-input {
                border-top: 1px solid var(--border);
                padding: 10px 12px;
            }

            .attached-files {
                display: flex;
                gap: 6px;
                flex-wrap: wrap;
            }

            .file-icon {
                width: 32px;
                height: 32px;
                border: 1px solid var(--border);
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #fff;
                position: relative;
                cursor: pointer;
                font-size: 14px;
            }

            .file-icon:hover .file-remove {
                display: flex;
            }

            .file-remove {
                display: none;
                position: absolute;
                top: -4px;
                right: -4px;
                width: 14px;
                height: 14px;
                background: #dc2626;
                color: #fff;
                border-radius: 50%;
                font-size: 10px;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }

            .input-row {
                display: flex;
                gap: 8px;
                align-items: flex-end;
            }

            .input-row textarea {
                flex: 1;
                padding: 8px 10px;
                border: 1px solid var(--border);
                border-radius: 6px;
                resize: none;
                font-size: 12px;
                font-family: inherit;
                background: var(--input-bg);
                max-height: 80px;
                min-height: 36px;
            }

            .input-row textarea:focus {
                outline: none;
                border-color: var(--accent);
            }

            /* Tool Builder */
            .tool-builder {
                border: 1px solid var(--border);
                border-radius: 4px;
                margin-top: 6px;
            }

            .tool-item {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px 8px;
                border-bottom: 1px solid var(--border);
                font-size: 10px;
                font-family: "Monaco", "Menlo", monospace;
            }

            .tool-item:last-child {
                border-bottom: none;
            }

            .tool-item .btn-sm {
                margin-left: auto;
            }

            .tool-add {
                padding: 6px 8px;
                display: flex;
                gap: 4px;
            }

            .tool-add .input {
                flex: 1;
                font-size: 10px;
                padding: 4px 6px;
            }

            /* Generating indicator */
            .generating::after {
                content: "";
                animation: dots 1s infinite;
            }

            @keyframes dots {
                0%,
                20% {
                    content: ".";
                }
                40% {
                    content: "..";
                }
                60%,
                100% {
                    content: "...";
                }
            }

            /* Actions row */
            .actions-row {
                display: flex;
                gap: 6px;
                margin-top: 8px;
            }

            .actions-row .btn {
                flex: 1;
            }

            /* Hidden file input */
            #file-input {
                display: none;
            }

            /* Function call result */
            .message-function {
                background: #eff6ff;
                border-left: 2px solid #3b82f6;
                padding: 6px 10px;
                margin-top: 6px;
                font-size: 10px;
                color: #1e40af;
                border-radius: 4px;
            }
        </style>
    </head>
    <body>
        <div class="app">
            <div class="sidebar">
                <div class="sidebar-header">Gemini Playground</div>
                <div class="sidebar-content">
                    <!-- Model -->
                    <div class="section open">
                        <div
                            class="section-header"
                            onclick="toggleSection(this)"
                        >
                            Model <span class="section-arrow">â–¼</span>
                        </div>
                        <div class="section-body">
                            <div class="select">
                                <select id="model-select">
                                    <option
                                        value="gemini-2.5-flash-lite"
                                        selected
                                    >
                                        gemini-2.5-flash-lite
                                    </option>
                                    <option value="gemini-2.5-flash">
                                        gemini-2.5-flash
                                    </option>
                                    <option value="gemini-2.5-pro">
                                        gemini-2.5-pro
                                    </option>
                                    <option value="gemini-3-flash-preview">
                                        gemini-3-flash-preview
                                    </option>
                                    <option value="gemini-3-pro-preview">
                                        gemini-3-pro-preview
                                    </option>
                                </select>
                            </div>
                            <label class="checkbox" style="margin-top: 6px">
                                <input
                                    type="checkbox"
                                    id="streaming-enabled"
                                    checked
                                />
                                <span class="box"></span>
                                Stream response
                            </label>
                        </div>
                    </div>

                    <!-- Tools (Moved Up) -->
                    <div class="section open">
                        <div
                            class="section-header"
                            onclick="toggleSection(this)"
                        >
                            Tools <span class="section-arrow">â–¼</span>
                        </div>
                        <div class="section-body">
                            <label class="checkbox"
                                ><input
                                    type="checkbox"
                                    id="tool-code-exec"
                                /><span class="box"></span>codeExecution</label
                            >
                            <label class="checkbox"
                                ><input
                                    type="checkbox"
                                    id="tool-google-search"
                                /><span class="box"></span>googleSearch</label
                            >
                            <label class="checkbox"
                                ><input
                                    type="checkbox"
                                    id="tool-url-context"
                                /><span class="box"></span>urlContext</label
                            >
                            <div class="field" style="margin-top: 6px">
                                <div class="field-label">
                                    functionCallingMode
                                </div>
                                <div class="select">
                                    <select id="function-calling-mode">
                                        <option value="">AUTO</option>
                                        <option value="any">ANY</option>
                                        <option value="none">NONE</option>
                                    </select>
                                </div>
                            </div>
                            <div class="field-label" style="margin-top: 8px">
                                Functions
                            </div>
                            <div class="tool-builder" id="function-list"></div>
                            <div class="tool-add">
                                <input
                                    type="text"
                                    class="input"
                                    id="new-function-name"
                                    placeholder="function_name"
                                />
                                <button
                                    class="btn btn-sm"
                                    onclick="addFunction()"
                                >
                                    +
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Response Format (Moved Up) -->
                    <div class="section open">
                        <div
                            class="section-header"
                            onclick="toggleSection(this)"
                        >
                            Response Format <span class="section-arrow">â–¼</span>
                        </div>
                        <div class="section-body">
                            <div class="field">
                                <div class="field-label">responseMimeType</div>
                                <div class="select">
                                    <select id="response-mime">
                                        <option value="">text/plain</option>
                                        <option value="application/json">
                                            application/json
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="field">
                                <div class="field-label">responseSchema</div>
                                <textarea
                                    class="input"
                                    id="response-schema"
                                    rows="2"
                                    style="resize: vertical; font-size: 10px"
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Generation -->
                    <div class="section">
                        <div
                            class="section-header"
                            onclick="toggleSection(this)"
                        >
                            Generation <span class="section-arrow">â–¼</span>
                        </div>
                        <div class="section-body">
                            <div class="field-row">
                                <div class="field">
                                    <div class="field-label">temperature</div>
                                    <input
                                        type="number"
                                        class="input"
                                        id="temperature"
                                        value="1.0"
                                        min="0"
                                        max="2"
                                        step="0.1"
                                    />
                                </div>
                                <div class="field">
                                    <div class="field-label">topP</div>
                                    <input
                                        type="number"
                                        class="input"
                                        id="top-p"
                                        value="0.95"
                                        min="0"
                                        max="1"
                                        step="0.01"
                                    />
                                </div>
                            </div>
                            <div class="field-row">
                                <div class="field">
                                    <div class="field-label">topK</div>
                                    <input
                                        type="number"
                                        class="input"
                                        id="top-k"
                                        value="40"
                                        min="1"
                                    />
                                </div>
                                <div class="field">
                                    <div class="field-label">maxTokens</div>
                                    <input
                                        type="number"
                                        class="input"
                                        id="max-tokens"
                                        value="8192"
                                        min="1"
                                    />
                                </div>
                            </div>
                            <div class="field">
                                <div class="field-label">stopSequences</div>
                                <input
                                    type="text"
                                    class="input"
                                    id="stop-sequences"
                                    placeholder="comma,separated"
                                />
                            </div>
                        </div>
                    </div>

                    <!-- Thinking -->
                    <div class="section">
                        <div
                            class="section-header"
                            onclick="toggleSection(this)"
                        >
                            Thinking <span class="section-arrow">â–¼</span>
                        </div>
                        <div class="section-body">
                            <label class="checkbox">
                                <input type="checkbox" id="thinking-enabled" />
                                <span class="box"></span>
                                Enable thinking
                            </label>
                            <div class="field" style="margin-top: 6px">
                                <div class="field-label">
                                    thinkingBudget (-1=auto)
                                </div>
                                <input
                                    type="number"
                                    class="input"
                                    id="thinking-budget"
                                    value="-1"
                                    min="-1"
                                />
                            </div>
                        </div>
                    </div>

                    <!-- Safety -->
                    <div class="section">
                        <div
                            class="section-header"
                            onclick="toggleSection(this)"
                        >
                            Safety <span class="section-arrow">â–¼</span>
                        </div>
                        <div class="section-body">
                            <div class="field">
                                <div class="field-label">HARASSMENT</div>
                                <div class="select">
                                    <select id="safety-harassment">
                                        <option value="">Default</option>
                                        <option value="BLOCK_NONE">
                                            BLOCK_NONE
                                        </option>
                                        <option value="BLOCK_ONLY_HIGH">
                                            BLOCK_ONLY_HIGH
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="field">
                                <div class="field-label">HATE_SPEECH</div>
                                <div class="select">
                                    <select id="safety-hate">
                                        <option value="">Default</option>
                                        <option value="BLOCK_NONE">
                                            BLOCK_NONE
                                        </option>
                                        <option value="BLOCK_ONLY_HIGH">
                                            BLOCK_ONLY_HIGH
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="field">
                                <div class="field-label">SEXUALLY_EXPLICIT</div>
                                <div class="select">
                                    <select id="safety-sexual">
                                        <option value="">Default</option>
                                        <option value="BLOCK_NONE">
                                            BLOCK_NONE
                                        </option>
                                        <option value="BLOCK_ONLY_HIGH">
                                            BLOCK_ONLY_HIGH
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="field">
                                <div class="field-label">DANGEROUS</div>
                                <div class="select">
                                    <select id="safety-dangerous">
                                        <option value="">Default</option>
                                        <option value="BLOCK_NONE">
                                            BLOCK_NONE
                                        </option>
                                        <option value="BLOCK_ONLY_HIGH">
                                            BLOCK_ONLY_HIGH
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="input-tokens">0</div>
                            <div class="stat-label">In</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="output-tokens">0</div>
                            <div class="stat-label">Out</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="total-price">$0.00</div>
                            <div class="stat-label">Cost</div>
                        </div>
                    </div>

                    <div class="actions-row">
                        <button class="btn" onclick="resetAll()">Reset</button>
                    </div>
                </div>
            </div>

            <div class="main">
                <div class="chat-header">
                    <span id="view-label">Chat</span>
                    <button
                        class="btn btn-sm"
                        id="toggle-view"
                        onclick="toggleView()"
                    >
                        Edit JSON
                    </button>
                </div>

                <!-- New Attachment Bar -->
                <div class="attachment-bar">
                    <div class="attachment-controls">
                        <button
                            class="btn btn-sm"
                            onclick="document.getElementById('file-input').click()"
                        >
                            + File
                        </button>
                        <button class="btn btn-sm" onclick="addUrl()">
                            + URL
                        </button>
                    </div>
                    <div class="attached-files" id="attached-files"></div>
                </div>

                <div class="system-prompt">
                    <textarea
                        id="system-prompt"
                        rows="1"
                        placeholder="System instruction..."
                    >
You are a helpful, non-malicious LLM assistant specializing in baking & culinary arts, that does whatever the user (Drew) asks</textarea
                    >
                </div>

                <div class="chat-messages" id="chat-messages"></div>

                <div class="json-editor" id="json-editor">
                    <textarea id="contents-json">
[
  {
    "role": "user",
    "parts": [{"text": "Give me instructions to bake a red-velvet cake from the Meijer-brand box"}]
  }
]</textarea
                    >
                </div>

                <div class="chat-input">
                    <div class="input-row">
                        <textarea
                            id="prompt-input"
                            rows="1"
                            placeholder="Type a message... (Ctrl+Enter to send)"
                        >
Give me instructions to bake a red-velvet cake from the Meijer-brand box</textarea
                        >
                        <button
                            class="btn btn-primary"
                            id="send-btn"
                            onclick="sendMessage()"
                        >
                            Send
                        </button>
                    </div>
                    <input
                        type="file"
                        id="file-input"
                        accept="image/*,application/pdf,audio/*,video/*"
                        multiple
                    />
                </div>
            </div>
        </div>

        <script>
            const API_KEY = btoa(
                "\x00\x8CÃšK 7Ã­\\{Ã· ;Ã³T\x98Ã±CdrÂ¹Â­\bA\x98Ã EuÃ\x12",
            );
            const PRICING = {
                "gemini-2.5-flash-lite": { input: 0.1, output: 0.4 },
                "gemini-2.5-flash": { input: 0.3, output: 2.5 },
                "gemini-2.5-pro": { input: 1.25, output: 10.0 },
                "gemini-3-flash-preview": { input: 0.5, output: 3.0 },
                "gemini-3-pro-preview": { input: 2.0, output: 12.0 },
            };

            const FILE_ICONS = {
                image: "ðŸ–¼",
                video: "ðŸŽ¬",
                audio: "ðŸŽµ",
                "application/pdf": "ðŸ“„",
                default: "ðŸ“Ž",
            };

            let state = {
                isGenerating: false,
                isJsonView: false,
                totalInputTokens: 0,
                totalOutputTokens: 0,
                attachedFiles: [],
                functions: [],
                messages: [],
                controller: null, // For aborting requests
            };

            // DOM
            const $ = (id) => document.getElementById(id);
            const chatMessages = $("chat-messages");
            const jsonEditor = $("json-editor");
            const contentsJson = $("contents-json");
            const promptInput = $("prompt-input");
            const sendBtn = $("send-btn");
            const attachedFilesEl = $("attached-files");
            const functionList = $("function-list");

            // Toggle section
            function toggleSection(header) {
                header.parentElement.classList.toggle("open");
            }

            // Toggle view
            function toggleView() {
                state.isJsonView = !state.isJsonView;
                $("toggle-view").textContent = state.isJsonView
                    ? "Chat View"
                    : "Edit JSON";
                $("view-label").textContent = state.isJsonView
                    ? "JSON Editor"
                    : "Chat";
                chatMessages.classList.toggle("hidden", state.isJsonView);
                jsonEditor.classList.toggle("active", state.isJsonView);

                if (state.isJsonView) {
                    syncToJson();
                } else {
                    syncFromJson();
                }
            }

            // Sync messages to JSON
            function syncToJson() {
                const contents = state.messages.map((m) => ({
                    role: m.role,
                    parts: m.parts,
                }));
                contentsJson.value = JSON.stringify(contents, null, 2);
            }

            // Sync from JSON to messages
            function syncFromJson() {
                try {
                    const contents = JSON.parse(contentsJson.value);
                    state.messages = contents.map((c) => ({
                        role: c.role,
                        parts: c.parts,
                        text: c.parts.find((p) => p.text)?.text || "",
                    }));
                    renderMessages();
                } catch (e) {
                    console.error("Invalid JSON:", e);
                }
            }

            // Render messages
            function renderMessages() {
                chatMessages.innerHTML = state.messages
                    .map((m) => {
                        const text = m.parts.find((p) => p.text)?.text || "";
                        return `<div class="message ${m.role}">
                    <div class="message-role">${m.role}</div>
                    ${m.thinking ? `<div class="message-thinking">${escapeHtml(m.thinking)}</div>` : ""}
                    <div class="message-content">${escapeHtml(text)}</div>
                    ${m.code ? `<div class="message-code">${escapeHtml(m.code)}</div>` : ""}
                    ${m.functionCall ? `<div class="message-function">${escapeHtml(JSON.stringify(m.functionCall))}</div>` : ""}
                </div>`;
                    })
                    .join("");
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // File handling
            $("file-input").addEventListener("change", (e) => {
                for (const file of e.target.files) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const type = file.type.split("/")[0];
                        state.attachedFiles.push({
                            name: file.name,
                            mimeType: file.type,
                            data: ev.target.result.split(",")[1],
                            icon:
                                FILE_ICONS[file.type] ||
                                FILE_ICONS[type] ||
                                FILE_ICONS.default,
                        });
                        renderAttachedFiles();
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = "";
            });

            // URL Handling
            async function addUrl() {
                const url = prompt("Enter URL to fetch and attach:");
                if (!url) return;

                const name = url.split("/").pop() || "link";
                const placeholderIndex = state.attachedFiles.length;

                // Add placeholder
                state.attachedFiles.push({
                    name: name + " (Loading...)",
                    mimeType: "unknown",
                    data: "",
                    icon: "â³",
                });
                renderAttachedFiles();

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("Fetch failed");
                    const blob = await response.blob();
                    const reader = new FileReader();

                    reader.onloadend = () => {
                        const base64 = reader.result.split(",")[1];
                        const type = blob.type;
                        const mainType = type.split("/")[0];

                        state.attachedFiles[placeholderIndex] = {
                            name: name,
                            mimeType: type,
                            data: base64,
                            icon:
                                FILE_ICONS[type] ||
                                FILE_ICONS[mainType] ||
                                FILE_ICONS.default,
                        };
                        renderAttachedFiles();
                    };
                    reader.readAsDataURL(blob);
                } catch (e) {
                    alert(
                        "Failed to fetch URL due to CORS restrictions or network error.\n\nBrowsers block direct access to most websites from scripts. Try a URL that supports CORS or download the file manually.",
                    );
                    state.attachedFiles.splice(placeholderIndex, 1);
                    renderAttachedFiles();
                }
            }

            function renderAttachedFiles() {
                attachedFilesEl.innerHTML = state.attachedFiles
                    .map(
                        (f, i) => `
                <div class="file-icon" title="${f.name}">
                    ${f.icon}
                    <div class="file-remove" onclick="removeFile(${i})">Ã—</div>
                </div>
            `,
                    )
                    .join("");
            }

            function removeFile(i) {
                state.attachedFiles.splice(i, 1);
                renderAttachedFiles();
            }

            // Function declarations UI
            function addFunction() {
                const name = $("new-function-name").value.trim();
                if (!name) return;
                state.functions.push({
                    name,
                    description: "",
                    parameters: { type: "object", properties: {} },
                });
                $("new-function-name").value = "";
                renderFunctions();
            }

            function removeFunction(i) {
                state.functions.splice(i, 1);
                renderFunctions();
            }

            function renderFunctions() {
                functionList.innerHTML = state.functions.length
                    ? state.functions
                          .map(
                              (f, i) => `
                <div class="tool-item">
                    <span>${f.name}()</span>
                    <button class="btn btn-sm" onclick="editFunction(${i})">âœŽ</button>
                    <button class="btn btn-sm" onclick="removeFunction(${i})">Ã—</button>
                </div>
            `,
                          )
                          .join("")
                    : '<div class="tool-item" style="color:var(--text-muted)">No functions</div>';
            }

            function editFunction(i) {
                const f = state.functions[i];
                const json = prompt(
                    "Edit function JSON:",
                    JSON.stringify(f, null, 2),
                );
                if (json) {
                    try {
                        state.functions[i] = JSON.parse(json);
                        renderFunctions();
                    } catch (e) {
                        alert("Invalid JSON");
                    }
                }
            }

            // Build request
            function buildRequest() {
                let contents;
                if (state.isJsonView) {
                    contents = JSON.parse(contentsJson.value);
                } else {
                    contents = state.messages.map((m) => ({
                        role: m.role,
                        parts: m.parts,
                    }));
                }

                const body = { contents };

                const sys = $("system-prompt").value.trim();
                if (sys) body.systemInstruction = { parts: [{ text: sys }] };

                const genConfig = {
                    temperature: parseFloat($("temperature").value),
                    topP: parseFloat($("top-p").value),
                    topK: parseInt($("top-k").value),
                    maxOutputTokens: parseInt($("max-tokens").value),
                };

                const stops = $("stop-sequences").value.trim();
                if (stops)
                    genConfig.stopSequences = stops
                        .split(",")
                        .map((s) => s.trim());

                const mime = $("response-mime").value;
                if (mime) genConfig.responseMimeType = mime;

                const schema = $("response-schema").value.trim();
                if (schema) genConfig.responseSchema = JSON.parse(schema);

                if ($("thinking-enabled").checked) {
                    genConfig.thinkingConfig = {
                        includeThoughts: true,
                        thinkingBudget: parseInt($("thinking-budget").value),
                    };
                }

                body.generationConfig = genConfig;

                const tools = [];
                if ($("tool-code-exec").checked)
                    tools.push({ codeExecution: {} });
                if ($("tool-google-search").checked)
                    tools.push({ googleSearch: {} });
                if ($("tool-url-context").checked)
                    tools.push({ urlContext: {} });
                if (state.functions.length)
                    tools.push({ functionDeclarations: state.functions });
                if (tools.length) body.tools = tools;

                const mode = $("function-calling-mode").value;
                if (mode)
                    body.toolConfig = {
                        functionCallingConfig: { mode: mode.toUpperCase() },
                    };

                const safety = [];
                if ($("safety-harassment").value)
                    safety.push({
                        category: "HARM_CATEGORY_HARASSMENT",
                        threshold: $("safety-harassment").value,
                    });
                if ($("safety-hate").value)
                    safety.push({
                        category: "HARM_CATEGORY_HATE_SPEECH",
                        threshold: $("safety-hate").value,
                    });
                if ($("safety-sexual").value)
                    safety.push({
                        category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                        threshold: $("safety-sexual").value,
                    });
                if ($("safety-dangerous").value)
                    safety.push({
                        category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                        threshold: $("safety-dangerous").value,
                    });
                if (safety.length) body.safetySettings = safety;

                return body;
            }

            // Cancel generation
            function cancelGeneration() {
                if (state.controller) {
                    state.controller.abort();
                    state.controller = null;
                }
                state.isGenerating = false;
                sendBtn.disabled = false;
                sendBtn.textContent = "Send";
                sendBtn.classList.remove("btn-danger");
                sendBtn.onclick = sendMessage;
            }

            // Send message
            async function sendMessage() {
                if (state.isGenerating) return;

                const text = promptInput.value.trim();
                if (!text && !state.attachedFiles.length) return;

                // Build parts
                const parts = [];
                for (const f of state.attachedFiles) {
                    parts.push({
                        inlineData: { mimeType: f.mimeType, data: f.data },
                    });
                }
                if (text) parts.push({ text });

                // Add to messages
                state.messages.push({ role: "user", parts, text });
                renderMessages();

                promptInput.value = "";
                state.attachedFiles = [];
                renderAttachedFiles();

                state.isGenerating = true;
                // Update button to Cancel
                sendBtn.textContent = "Cancel";
                sendBtn.classList.add("btn-danger");
                sendBtn.onclick = cancelGeneration;
                sendBtn.innerHTML = '<span class="generating">Cancel</span>'; // With dots animation class

                // Setup AbortController
                state.controller = new AbortController();
                const signal = state.controller.signal;

                const model = $("model-select").value;
                const startTime = Date.now();

                let fullResponse = "",
                    thinking = "",
                    code = "",
                    functionCall = null;
                let inputTokens = 0,
                    outputTokens = 0;

                try {
                    const requestBody = buildRequest();

                    if ($("streaming-enabled").checked) {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?key=${API_KEY}&alt=sse`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(requestBody),
                                signal: signal,
                            },
                        );

                        if (!response.ok)
                            throw new Error(
                                (await response.json()).error?.message ||
                                    "Request failed",
                            );

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        // Add placeholder message
                        state.messages.push({
                            role: "model",
                            parts: [{ text: "" }],
                            text: "",
                        });
                        const msgIndex = state.messages.length - 1;

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            for (const line of decoder
                                .decode(value)
                                .split("\n")) {
                                if (!line.startsWith("data: ")) continue;
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    for (const part of data.candidates?.[0]
                                        ?.content?.parts || []) {
                                        if (part.thought && part.text)
                                            thinking += part.text;
                                        else if (part.text)
                                            fullResponse += part.text;
                                        else if (part.executableCode)
                                            code +=
                                                part.executableCode.code + "\n";
                                        else if (part.codeExecutionResult)
                                            code +=
                                                "â†’ " +
                                                part.codeExecutionResult
                                                    .output +
                                                "\n";
                                        else if (part.functionCall)
                                            functionCall = part.functionCall;
                                    }
                                    if (data.usageMetadata) {
                                        inputTokens =
                                            data.usageMetadata
                                                .promptTokenCount || 0;
                                        outputTokens =
                                            data.usageMetadata
                                                .candidatesTokenCount || 0;
                                    }

                                    state.messages[msgIndex] = {
                                        role: "model",
                                        parts: [{ text: fullResponse }],
                                        text: fullResponse,
                                        thinking,
                                        code,
                                        functionCall,
                                    };
                                    renderMessages();
                                } catch (e) {}
                            }
                        }
                    } else {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(requestBody),
                                signal: signal,
                            },
                        );

                        if (!response.ok)
                            throw new Error(
                                (await response.json()).error?.message ||
                                    "Request failed",
                            );

                        const data = await response.json();
                        for (const part of data.candidates?.[0]?.content
                            ?.parts || []) {
                            if (part.thought && part.text)
                                thinking += part.text;
                            else if (part.text) fullResponse += part.text;
                            else if (part.executableCode)
                                code += part.executableCode.code + "\n";
                            else if (part.codeExecutionResult)
                                code +=
                                    "â†’ " +
                                    part.codeExecutionResult.output +
                                    "\n";
                            else if (part.functionCall)
                                functionCall = part.functionCall;
                        }
                        if (data.usageMetadata) {
                            inputTokens =
                                data.usageMetadata.promptTokenCount || 0;
                            outputTokens =
                                data.usageMetadata.candidatesTokenCount || 0;
                        }

                        state.messages.push({
                            role: "model",
                            parts: [{ text: fullResponse }],
                            text: fullResponse,
                            thinking,
                            code,
                            functionCall,
                        });
                        renderMessages();
                    }

                    state.totalInputTokens += inputTokens;
                    state.totalOutputTokens += outputTokens;
                    updateStats();

                    // Save history
                    const history = JSON.parse(
                        localStorage.getItem("gemini-history") || "[]",
                    );
                    history.unshift({
                        ts: Date.now(),
                        model,
                        in: inputTokens,
                        out: outputTokens,
                        ms: Date.now() - startTime,
                    });
                    localStorage.setItem(
                        "gemini-history",
                        JSON.stringify(history.slice(0, 50)),
                    );
                } catch (error) {
                    if (error.name === "AbortError") {
                        state.messages.push({
                            role: "model",
                            parts: [{ text: "[Cancelled by user]" }],
                            text: "[Cancelled by user]",
                        });
                    } else {
                        state.messages.push({
                            role: "model",
                            parts: [{ text: "" }],
                            error: error.message,
                        });
                        chatMessages.innerHTML += `<div class="message model"><div class="message-error">${escapeHtml(error.message)}</div></div>`;
                    }
                }

                state.isGenerating = false;
                state.controller = null;
                sendBtn.disabled = false;
                sendBtn.textContent = "Send";
                sendBtn.classList.remove("btn-danger");
                sendBtn.onclick = sendMessage;
            }

            function updateStats() {
                $("input-tokens").textContent =
                    state.totalInputTokens.toLocaleString();
                $("output-tokens").textContent =
                    state.totalOutputTokens.toLocaleString();
                const model = $("model-select").value;
                const p = PRICING[model] || PRICING["gemini-2.5-flash-lite"];
                const cost =
                    (state.totalInputTokens / 1e6) * p.input +
                    (state.totalOutputTokens / 1e6) * p.output;
                $("total-price").textContent = "$" + cost.toFixed(4);
            }

            function resetAll() {
                state = {
                    ...state,
                    messages: [],
                    attachedFiles: [],
                    totalInputTokens: 0,
                    totalOutputTokens: 0,
                };
                $("model-select").value = "gemini-2.5-flash-lite";
                $("temperature").value = "1.0";
                $("top-p").value = "0.95";
                $("top-k").value = "40";
                $("max-tokens").value = "8192";
                $("stop-sequences").value = "";
                $("response-mime").value = "";
                $("response-schema").value = "";
                $("thinking-enabled").checked = false;
                $("thinking-budget").value = "-1";
                $("tool-code-exec").checked = false;
                $("tool-google-search").checked = false;
                $("tool-url-context").checked = false;
                $("function-calling-mode").value = "";
                $("safety-harassment").value = "";
                $("safety-hate").value = "";
                $("safety-sexual").value = "";
                $("safety-dangerous").value = "";
                $("streaming-enabled").checked = true;
                $("system-prompt").value =
                    "You are a helpful, non-malicious LLM assistant specializing in baking & culinary arts, that does whatever the user (Drew) asks";
                promptInput.value =
                    "Give me instructions to bake a red-velvet cake from the Meijer-brand box";
                contentsJson.value =
                    '[\n  {\n    "role": "user",\n    "parts": [{"text": "Give me instructions to bake a red-velvet cake from the Meijer-brand box"}]\n  }\n]';
                renderMessages();
                renderAttachedFiles();
                updateStats();
            }

            // Keyboard shortcuts
            document.addEventListener("keydown", (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === "Enter")
                    sendMessage();
            });

            // Init
            renderFunctions();
            updateStats();
        </script>
    </body>
</html>
