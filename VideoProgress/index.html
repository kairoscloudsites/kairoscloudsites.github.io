<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Video Render Progress</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --green: #28a745;
                --blue: #007bff;
                --light-gray: #f0f2f5;
                --gray: #6c757d;
                --border-color: #dee2e6;
                --white: #ffffff;
                --black: #212529;
            }

            body {
                font-family: "Poppins", sans-serif;
                background-color: var(--light-gray);
                color: var(--black);
                margin: 0;
                padding: 2rem;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
            }

            .container {
                background-color: var(--white);
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                padding: 2.5rem;
                max-width: 500px;
                width: 100%;
                text-align: center;
            }

            h1 {
                margin-top: 0;
                margin-bottom: 2rem;
                color: var(--black);
            }

            .error-message {
                color: #dc3545;
                background-color: #f8d7da;
                border: 1px solid #f5c6cb;
                padding: 1rem;
                border-radius: 6px;
            }

            .progress-stepper {
                list-style: none;
                padding-left: 0;
                margin: 0;
                text-align: left;
            }

            .step {
                display: flex;
                align-items: flex-start;
                position: relative;
            }

            .step:not(:last-child)::before {
                content: "";
                position: absolute;
                left: 16.5px;
                top: 36px;
                width: 3px;
                height: calc(100% - 20px);
                background-color: var(--border-color);
                transition: background-color 0.3s ease;
            }

            .step.complete:not(:last-child)::before {
                background-color: var(--green);
            }

            .step-indicator {
                flex-shrink: 0;
                margin-right: 1.5rem;
                position: relative;
            }

            .circle {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                font-weight: 600;
                font-size: 1rem;
                transition: all 0.3s ease;
                position: relative;
                background-color: var(--white);
                border: 2px solid var(--border-color);
                color: var(--gray);
            }

            .step.in-progress .circle {
                color: var(--black);
                border-color: var(--border-color);
            }

            .step.in-progress .circle::before {
                content: "";
                position: absolute;
                top: -2px;
                left: -2px;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                border: 2px solid transparent;
                border-top-color: var(--blue);
                animation: spin 1s linear infinite;
            }

            .step.complete .circle {
                background-color: var(--green);
                border-color: var(--green);
                color: var(--white);
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .step-content {
                padding-top: 0.3rem;
                padding-bottom: 2rem;
            }

            .step-title {
                font-weight: 600;
                margin: 0;
                display: flex;
                align-items: center;
            }

            .timer-text {
                color: var(--gray);
                font-weight: 400;
                font-size: 0.9em;
                margin-top: 3px;
                margin-left: 6px;
            }

            .final-actions-container {
                display: none; /* Hidden by default */
                margin-top: 1rem;
                padding-top: 1.5rem;
                border-top: 1px solid var(--border-color);
            }

            .final-actions-container a {
                text-decoration: none;
                font-weight: 600;
                margin: 0 0.5rem;
            }

            .download-button {
                display: inline-block;
                background-color: #3182c2;
                color: var(--white);
                padding: 0.6rem 1.2rem;
                border-radius: 6px;
                margin-top: 0.5rem;
                transition: background-color 0.2s ease;
            }

            .download-button:hover {
                background-color: #0056b3;
                color: var(--white);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Checking Render Status...</h1>

            <ol class="progress-stepper">
                <!-- Step 1: Always complete -->
                <li id="step1" class="step complete">
                    <div class="step-indicator">
                        <div class="circle">1</div>
                    </div>
                    <div class="step-content">
                        <p class="step-title">Video selected</p>
                    </div>
                </li>

                <!-- Step 2: Render -->
                <li id="step2" class="step">
                    <div class="step-indicator">
                        <div class="circle">2</div>
                    </div>
                    <div class="step-content">
                        <p id="step2-title" class="step-title">
                            Video rendered
                            <span id="render-timer" class="timer-text"></span>
                        </p>
                    </div>
                </li>
            </ol>

            <!-- This section is populated and shown by JS on completion -->
            <div id="final-actions" class="final-actions-container"></div>

            <div id="error-container"></div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const params = new URLSearchParams(window.location.search);
                const shotstackId = params.get("id");

                const errorContainer =
                    document.getElementById("error-container");
                if (!shotstackId) {
                    errorContainer.innerHTML = `
                    <p class="error-message">
                        <strong>Error:</strong> URL parameter 'id' is required.
                        <br>
                        Example: ?id=your-video-id
                    </p>`;
                    document.querySelector("h1").textContent =
                        "Configuration Error";
                    return;
                }

                // --- DOM Element References ---
                const step2 = document.getElementById("step2");
                const step2Title = document.getElementById("step2-title");
                const timerElement = document.getElementById("render-timer");
                const finalActionsContainer =
                    document.getElementById("final-actions");
                let timerInterval;

                const videoUrl = `https://shotstack-api-v1-output.s3.ap-southeast-2.amazonaws.com/rgrqdk03ju/${shotstackId}.mp4`;

                function setStepState(stepElement, state) {
                    stepElement.classList.remove("in-progress", "complete");
                    stepElement.classList.add(state);
                }

                function startRenderTimer() {
                    const startTime = Date.now();
                    timerElement.textContent = "0:00";

                    timerInterval = setInterval(() => {
                        const elapsedSeconds = Math.floor(
                            (Date.now() - startTime) / 1000,
                        );
                        const minutes = Math.floor(elapsedSeconds / 60);
                        const seconds = elapsedSeconds % 60;
                        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
                    }, 1000);
                }

                async function checkRenderStatus() {
                    setStepState(step2, "in-progress");
                    startRenderTimer();

                    const intervalId = setInterval(async () => {
                        try {
                            const response = await fetch(videoUrl, {
                                method: "HEAD",
                            });

                            if (response.ok) {
                                clearInterval(intervalId);
                                clearInterval(timerInterval);
                                console.log(
                                    "Step 2 Complete: Video is rendered.",
                                );

                                setStepState(step2, "complete");
                                document.querySelector("h1").textContent =
                                    "Render Complete!";

                                // Update title to be a link, keeping the timer text static
                                step2Title.innerHTML = `
                                    <a href="${videoUrl}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">Video rendered</a>
                                    <span class="timer-text">${timerElement.textContent}</span>
                                `;

                                // Display the final actions
                                finalActionsContainer.innerHTML = `
                                    <a href="${videoUrl}" target="_blank" style="color: #3182C2" rel="noopener noreferrer">Open Link</a>
                                    <a class="download-button" onclick=downloadVideo("${videoURL}")>Download Video</a>
                                `;
                                finalActionsContainer.style.display = "block";
                            } else {
                                console.log("Polling for video render...");
                            }
                        } catch (error) {
                            console.error(
                                "Polling error for render status:",
                                error,
                            );
                        }
                    }, 3000);
                }

                // Start the process
                checkRenderStatus();

                function downloadVideo(url) {
                    // Generate a random 10-digit hex string
                    const randomHex = [...Array(10)]
                        .map(() => Math.floor(Math.random() * 16).toString(16))
                        .join("");

                    const fileName = `KairosCloud_${randomHex}.mp4`;

                    // Create an anchor element and trigger download
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            });
        </script>
    </body>
</html>
